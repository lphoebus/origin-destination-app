import{fg as j,bu as F,bj as I,bH as w,bq as g}from"./index-C2z3vZ9k.js";import{B as S,x as T,j as h}from"./queryUtils-2piN-80C.js";import{d as q,O as v,V as O}from"./QueryEngine-Cqn83zZU.js";import{I as Q}from"./timeSupport-CJsGYDu-.js";async function A(e,i,f){const a=j(f),{point:t,distance:n,returnEdge:p,vertexMode:o}=i;if(!p&&o==="none")return{candidates:[]};let r=F(i.query);r=await e.schedule((()=>S(r,e.definitionExpression,e.spatialReference)),a),r=await e.reschedule((()=>q(r,{availableFields:e.availableFields,fieldsIndex:e.fieldsIndex,geometryType:e.geometryType,spatialReference:e.spatialReference})),a);const u=!I(t.spatialReference,e.spatialReference);u&&await T(t.spatialReference,e.spatialReference);const m=typeof n=="number"?n:n.x,d=typeof n=="number"?n:n.y,y={xmin:t.x-m,xmax:t.x+m,ymin:t.y-d,ymax:t.y+d,spatialReference:t.spatialReference},s=u?h(y,e.spatialReference):y;if(!s)return{candidates:[]};const x=(await w(g(t),null,{signal:a}))[0],c=(await w(g(s),null,{signal:a}))[0];if(x==null||c==null)return{candidates:[]};const l=new v(await e.reschedule((()=>e.searchFeatures(O(c.toJSON()))),a),r,e);await e.reschedule((()=>e.executeObjectIdsQuery(l)),a),await e.reschedule((()=>e.executeTimeQuery(l)),a),await e.reschedule((()=>e.executeAttributesQuery(l)),a),await e.reschedule((()=>E(e,l,a)),a);const R=x.toJSON(),b=u?h(R,e.spatialReference):R,$=u?Math.max(s.xmax-s.xmin,s.ymax-s.ymin)/2:n;return l.createSnappingResponse({...i,point:b,distance:$},r.returnZ,t.spatialReference)}async function E(e,i,f){var o;const{query:a}=i,{spatialRel:t}=a;if(!((o=i==null?void 0:i.items)!=null&&o.length)||!a.geometry||!t)return;const n=await Q(t,a.geometry,e.geometryType,e.hasZ,e.hasM),p=await e.runSpatialFilter(i.items,(r=>n(r.geometry)),f);i.items=p}export{A as u};
