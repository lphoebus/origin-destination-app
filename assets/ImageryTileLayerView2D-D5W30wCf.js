import{iq as A,eq as Ke,kd as $e,kg as ms,ki as Qe,kj as Oe,kl as fs,mA as gs,kh as St,bb as u,kB as Ee,kC as Xe,kD as ys,en as ws,eo as bs,ep as xs,er as _s,es as vs,d2 as De,om as ce,cR as et,df as Pt,kE as Cs,eK as Ts,hB as Rs,aN as Ss,e4 as bt,aZ as Ps,pC as Is,e1 as zs,e2 as ks,e3 as $s,dT as xt,co as Ms,be as Fs,dV as ze,b5 as ke,bc as C,bd as Me,wf as Vs,aP as Bs,wg as It,kA as Os,aO as Ae,ay as Ds,bp as As,gO as Gs,ea as Us}from"./index-C2z3vZ9k.js";import{r as zt,V as qs,k as Ce,s as js,x as _t}from"./rasterFieldUtils-8FBWYX_U.js";import{f as Ls,d as Es,h as Ws}from"./RasterVFDisplayObject-CyHtU6Lw.js";import{S as Ns,u as Zs}from"./LayerView-CPeRSnbP.js";import{x as Hs}from"./clipUtils-BvllJZeO.js";import{e as Qs}from"./Container-CV2f8I_O.js";import{m as Xs,c as Ys,s as Js,l as tt}from"./rasterUtils-AQik6xNH.js";import{r as kt}from"./WGLContainer-BZJApB0t.js";import{i as $t}from"./TileContainer-CniZrGqU.js";import{z as Y,Z as K,I,M as ee,T as pt,Y as W,e as w,d as S,q as V,c as _,N as Ks,O as vt,X as b,k as j,B as Mt,y as E,g as m,U as ie,P as z,j as Ft,w as Vt,V as L,f as Bt,r as _e,_ as d,K as v,$ as he,m as We,i as Ot,v as Dt,n as N,D as st,p as it,Q as O,a0 as X,A as te,W as J,t as dt,a1 as we,a as At,E as Ne,u as D,b as ye,a2 as ae,a3 as ei,G as oe,a4 as ti,a5 as si,a6 as ii,a7 as ri,a8 as ai,a9 as oi,aa as ni,ab as li,ac as ui,ad as ci,ae as hi,af as pi,s as di,ag as mi,F as fi,ah as gi,ai as yi,aj as wi,ak as bi,al as xi,am as _i,an as vi,ao as Ye,ap as Ci,C as mt,x as Ti,aq as Ri,ar as Si,as as Pi}from"./GraphShaderModule-B9_UmIx1.js";import{t as k}from"./TechniqueType-pk2C5RYg.js";import{m as Ii}from"./bitmapUtils-BYui5yO1.js";import{D as be,z as zi}from"./utils-CACl0e8b.js";import{R as ki}from"./FramebufferObject-VOwZdCdO.js";import{v as xe,c as $i,S as Mi}from"./dataUtils-0RHTvcdC.js";import{g as Ct,a as Tt,i as Fi,u as Vi}from"./RawBlockCache-4JaVFecA.js";import{e as Bi,x as Oi,C as Di,m as Rt,O as Ai}from"./rasterProjectionHelper-BadGIF5p.js";import{i as Gi}from"./timeSupport-Cux_hQxh.js";import{p as Ui}from"./popupUtils-G5ArJUq7.js";import{i as qi}from"./RefreshableLayerView-Ds00HdSF.js";import"./ProgramTemplate-BWlKZXFz.js";import"./VertexElementDescriptor-BLyltQyJ.js";import"./Utils-C5jEUm36.js";import"./layerViewUtils-DH0dJCjx.js";import"./vec3f32-WCVSSNPR.js";import"./StyleDefinition-CDh4Tp6C.js";import"./config-DHajyIwB.js";import"./earcut-D9gy186-.js";import"./featureConversionUtils-BHcwWift.js";import"./ShaderBuilder-B3IMbU-q.js";import"./BindType-BBwFZqyN.js";import"./constants-BFLErLYb.js";const ji={bandCount:3,minOutput:0,maxOutput:1,minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],colormap:null,colormapOffset:null,stretchType:"none",type:"stretch"};let Li=class extends Qs{constructor(e=null,t=null,s=null){super(),this._textureInvalidated=!0,this._colormapTextureInvalidated=!0,this._rasterTexture=null,this._maskTexture=null,this._rasterTextureBandIds=null,this._transformGridTexture=null,this._colormapTexture=null,this._colormap=null,this._supportsBilinearTexture=!0,this._processedTexture=null,this.functionTextures=[],this.projected=!1,this.stencilRef=0,this.coordScale=[1,1],this._processed=!1,this._symbolizerParameters=null,this.height=null,this.isRendereredSource=!1,this.pixelRatio=1,this.resolution=0,this.rotation=0,this._source=null,this._mask=null,this.rawPixelData=null,this._suspended=!1,this._bandIds=null,this._interpolation=null,this._transformGrid=null,this.width=null,this.x=0,this.y=0,this.source=e,this.transformGrid=t,this.interpolation=s}destroy(){this._disposeTextures()}get processedTexture(){return this._processedTexture}set processedTexture(e){this._processedTexture!==e&&(this._disposeTextures(!0),this._processedTexture=e)}get rasterTexture(){return this._rasterTexture}set rasterTexture(e){var t;this._rasterTexture!==e&&((t=this._rasterTexture)==null||t.dispose(),this._rasterTexture=e),e==null&&(this.projected=!1)}get processed(){return this._processed}set processed(e){this._processed=e,e||(this.processedTexture=A(this.processedTexture),this.invalidateTexture())}get symbolizerParameters(){return this._symbolizerParameters||ji}set symbolizerParameters(e){this._symbolizerParameters!==e&&(this._symbolizerParameters=e,this._colormapTextureInvalidated=!0)}get source(){return this._source}set source(e){this._source!==e&&(this._source=e,this._rasterTexture&&(this._rasterTexture=A(this._rasterTexture),this._rasterTextureBandIds=null),this.projected=!1,this.invalidateTexture())}get mask(){return this._mask}set mask(e){this._mask!==e&&(this._mask=e,this._maskTexture=A(this._maskTexture))}get suspended(){return this._suspended}set suspended(e){this._suspended&&!e&&this.stage&&(this.ready(),this.requestRender()),this._suspended=e}get bandIds(){return this._bandIds}set bandIds(e){this._bandIds=e,this._isBandIdsChanged(e)&&(this.projected=!1,this.invalidateTexture())}get interpolation(){return this._interpolation||"nearest"}set interpolation(e){this._interpolation=e,this._rasterTexture&&this._rasterTexture.setSamplingMode(this._getTextureSamplingMethod(e||"nearest")==="bilinear"?Ke.LINEAR:Ke.NEAREST)}get transformGrid(){return this._transformGrid}set transformGrid(e){this._transformGrid!==e&&(this._transformGrid=e,this._transformGridTexture=A(this._transformGridTexture))}invalidateTexture(){this._textureInvalidated||(this._textureInvalidated=!0,this.requestRender())}getRasterTextureSize(e=!1){var s,a;const t=e||this.projected;return[t?this.width:((s=this.source)==null?void 0:s.width)||this.width,t?this.height:((a=this.source)==null?void 0:a.height)||this.height]}getRasterCellSize(){var a;const e=(a=this.rawPixelData)==null?void 0:a.srcPixelSize,{projected:t,resolution:s}=this;return e&&!t?[e.x,e.y]:[s,s]}_createTransforms(){return{displayViewScreenMat3:$e()}}setTransform(e){const t=ms(this.transforms.displayViewScreenMat3),[s,a]=e.toScreenNoRotation([0,0],[this.x,this.y]),r=this.resolution/this.pixelRatio/e.resolution,o=r*this.width,n=r*this.height,l=Math.PI*this.rotation/180;Qe(t,t,Oe(s,a)),Qe(t,t,Oe(o/2,n/2)),fs(t,t,-l),Qe(t,t,Oe(-o/2,-n/2)),gs(t,t,Oe(o,n)),St(this.transforms.displayViewScreenMat3,e.displayViewMat3,t)}getTextures({forProcessing:e=!1,useProcessedTexture:t=!1}={}){const s=t?this._processedTexture??this._rasterTexture:this._rasterTexture,a=[],r=[];return s?(this._transformGridTexture&&!this.projected&&(r.push(this._transformGridTexture),a.push("u_transformGrid")),r.push(s),a.push("u_image"),!this._colormapTexture||!t&&e||(r.push(this._colormapTexture),a.push("u_colormap")),this._maskTexture&&(r.push(this._maskTexture),a.push("u_mask")),{names:a,textures:r}):{names:a,textures:r}}onAttach(){this.invalidateTexture()}onDetach(){this.invalidateTexture()}updateTexture({context:e}){if(!this.stage)return void this._disposeTextures();const t=this._isValidSource(this.source);t&&this._colormapTextureInvalidated&&(this._colormapTextureInvalidated=!1,this._updateColormapTexture(e)),this._textureInvalidated&&(this._textureInvalidated=!1,this._createOrDestroyRasterTexture(e),this._rasterTexture&&(t?(this.transformGrid&&!this._transformGridTexture&&(this._transformGridTexture=Xs(e,this.transformGrid)),this._mask&&!this._maskTexture&&(this._maskTexture=Ys(e,this._mask,[this.width,this.height]))):this._rasterTexture.setData(null)),this.suspended||(this.ready(),this.requestRender()))}updateProcessedTexture(){const{functionTextures:e}=this;e.length!==0&&(this.processedTexture=e.shift(),e.forEach((t=>t==null?void 0:t.dispose())),e.length=0,this.processed=!!this.processedTexture)}_createOrDestroyRasterTexture(e){var o;const t=(o=this.source)==null?void 0:o.extractBands(this.bandIds);if(!this._isValidSource(t))return void(this._rasterTexture&&(this._rasterTexture=A(this._rasterTexture),this._rasterTextureBandIds=null));const s=!this._isBandIdsChanged(this.bandIds);if(this._rasterTexture){if(s)return;this._rasterTexture=A(this._rasterTexture),this._rasterTextureBandIds=null}this._supportsBilinearTexture=!!e.capabilities.textureFloatLinear;const a=this._getTextureSamplingMethod(this.interpolation),r=this.isRendereredSource;this._rasterTexture=Js(e,t,a,r),this.projected=!1,this._processed=!1,this._rasterTextureBandIds=this.bandIds?[...this.bandIds]:null}_isBandIdsChanged(e){const t=this._rasterTextureBandIds;return!(t==null&&e==null||t&&e&&t.join("")===e.join(""))}_isValidSource(e){var t;return e!=null&&((t=e.pixels)==null?void 0:t.length)>0}_getTextureSamplingMethod(e){const{type:t}=this.symbolizerParameters,s=t==="lut"&&!this.symbolizerParameters.isClassBreaks||t==="hillshade"||t==="stretch"&&this.symbolizerParameters.bandCount===1;return!this._supportsBilinearTexture||s||e!=="bilinear"&&e!=="cubic"?"nearest":"bilinear"}_updateColormapTexture(e){const t=this._colormap,s=this.symbolizerParameters.colormap;return s?t?s.length!==t.length||s.some(((a,r)=>a!==t[r]))?(this._colormapTexture&&(this._colormapTexture=A(this._colormapTexture)),this._colormapTexture=tt(e,s),void(this._colormap=s)):void 0:(this._colormapTexture=tt(e,s),void(this._colormap=s)):(this._colormapTexture&&(this._colormapTexture=A(this._colormapTexture)),void(this._colormap=null))}_disposeTextures(e=!1){e?this.projected&&(this._transformGridTexture=A(this._transformGridTexture)):(this._rasterTexture=A(this._rasterTexture),this._colormapTexture=A(this._colormapTexture),this._transformGridTexture=A(this._transformGridTexture),this._maskTexture=A(this._maskTexture),this._rasterTextureBandIds=null,this._colormap=null,this._colormapTextureInvalidated=!0),this._processedTexture=A(this._processedTexture)}},Ei=class extends kt{constructor(e,t,s,a,r,o,n=null){super(e,t,s,a,r,o),this.bitmap=null,this.bitmap=new Li(n,null,null),this.bitmap.coordScale=[r,o],this.bitmap.once("isReady",(()=>this.ready()))}destroy(){super.destroy(),this.bitmap.destroy(),this.bitmap=null,this.stage=null}set stencilRef(e){this.bitmap.stencilRef=e}get stencilRef(){return this.bitmap.stencilRef}setTransform(e){super.setTransform(e),this.bitmap.transforms.displayViewScreenMat3=this.transforms.displayViewScreenMat3}_createTransforms(){return{displayViewScreenMat3:$e(),tileMat3:$e()}}onAttach(){this.bitmap.stage=this.stage}onDetach(){this.bitmap.stage=null}};function Wi(i,e,t,s){const a=Y(e.multiply(t)),r=new K(new I(a.x),new I(a.y)),o=new K(r.x.add(1),r.y),n=new K(r.x,r.y.add(1)),l=new K(r.x.add(1),r.y.add(1)),c=ee(i,r,new I(0)),p=ee(i,o,new I(0)),h=ee(i,n,new I(0)),f=ee(i,l,new I(0)),g=pt(e.multiply(t)),y=W(c,p,g.x),x=W(h,f,g.x),T=W(y,x,g.y);if(!s)return T;const P=new w(c.a,p.a,h.a,f.a),R=P.xy.multiply(P.zw),q=Y(R.x.multiply(R.y).add(.5)),Z=T.multiply(q),He=be(q).multiply(S(i,e));return Z.add(He)}class Te extends z{}function Ni(i,e){const t=S(e.transformTexture,i);return new _(t.r,t.g)}function Zi(i,e){const{transformTexture:t,targetImageSize:s,transformSpacing:a}=e,r=Y(i.multiply(s)),o=new _(4,1),n=Y(r.divide(a)).multiply(o),l=pt(r.add(new _(.5,.5)).divide(a)),c=new K(vt(n.x),vt(n.y)),p=new b(l,1);return j(Mt(l.x,l.y),Hi(t,c,p),Qi(t,c,p))}function Hi(i,e,t){const s=ee(i,e,new I(0)),a=new K(e.x.add(1),e.y),r=ee(i,a,new I(0));return new _(E(s.rgb,t),E(r.rgb,t))}function Qi(i,e,t){const s=new K(e.x.add(2),e.y),a=ee(i,s,new I(0)),r=new K(e.x.add(3),e.y),o=ee(i,r,new I(0));return new _(E(a.rgb,t),E(o.rgb,t))}function Xi(i){const e=V(new _(-1e-5,-1e-5),i).multiply(V(i,new _(1.00001,1.00001))),t=be(e.x.multiply(e.y));return new Ks(t)}function Gt(i,e,t=!1){return e?t?Ni(i,e):Zi(i,e):i}function Ut(i,e,t){const{bicubic:s=!1,bilinear:a=!1,nearestOnEdge:r=!1}=t??{};return s||a?s?Ii(e.texture,i,e.srcImageSize):Wi(e.texture,i,e.srcImageSize,r):S(e.texture,i)}u([m(ie)],Te.prototype,"transformTexture",void 0),u([m(_)],Te.prototype,"targetImageSize",void 0),u([m(_)],Te.prototype,"transformSpacing",void 0),u([m(_)],Te.prototype,"transformGridSize",void 0);let qt=class extends Ot{};u([Bt(0,_)],qt.prototype,"position",void 0);let Yi=class extends Dt{},pe=class extends z{};u([m(ie)],pe.prototype,"texture",void 0),u([m(_e)],pe.prototype,"dvsMat3",void 0),u([m(_)],pe.prototype,"coordScale",void 0),u([m(_)],pe.prototype,"srcImageSize",void 0),u([m(d)],pe.prototype,"opacity",void 0);class jt extends z{}u([m(ie)],jt.prototype,"maskTexture",void 0);class G extends Ft{constructor(){super(...arguments),this.applyProjection=!0,this.lookupProjection=!1,this.bilinear=!1,this.bicubic=!1,this.nearestOnEdge=!1,this.applyPixelMask=!1}vertex(e){const t=e.position,{dvsMat3:s,coordScale:a}=this.config,r=s.multiply(new b(t.multiply(a),1));return{uv:t,glPosition:new w(r,1)}}fragment(e){const t=new Vt,s=Gt(e.uv,this.applyProjection?this.projectionConfig:void 0,this.lookupProjection),a=j(Xi(s),new w(0,0,0,0),this._colorize(s));let r=a.a.multiply(this.config.opacity);if(this.applyPixelMask){const o=this._getPixelMask(e.uv);r=r.multiply(o)}return t.fragColor=new w(a.rgb,1).multiply(r),t}_getPixel(e){const{config:t,bicubic:s,bilinear:a,nearestOnEdge:r}=this;return Ut(e,t,{bicubic:s,bilinear:a,nearestOnEdge:r})}_getPixelMask(e){const{maskTexture:t}=this.pixelMaskConfig,s=S(t,e);return L(s.a)}}u([v],G.prototype,"applyProjection",void 0),u([v],G.prototype,"lookupProjection",void 0),u([v],G.prototype,"bilinear",void 0),u([v],G.prototype,"bicubic",void 0),u([v],G.prototype,"nearestOnEdge",void 0),u([v],G.prototype,"applyPixelMask",void 0),u([m(pe)],G.prototype,"config",void 0),u([he(Te)],G.prototype,"projectionConfig",void 0),u([he(jt)],G.prototype,"pixelMaskConfig",void 0),u([Ee(0,We(qt))],G.prototype,"vertex",null),u([Ee(0,We(Yi))],G.prototype,"fragment",null);let se=class extends z{};function Fe(i,e,t,s=!0){const{colormapTexture:a,colormapOffset:r,colormapMaxIndex:o}=t,n=i.r.multiply(e).subtract(r),l=N(n,new d(0),o),c=new _(l.add(.5).divide(o.add(1)),0),p=S(a,c),h=new w(p.rgb,p.a.multiply(i.a));if(s)return h;const f=V(new d(0),n).multiply(V(n,t.colormapMaxIndex));return h.multiply(f)}u([m(ie)],se.prototype,"colormapTexture",void 0),u([m(d)],se.prototype,"colormapOffset",void 0),u([m(d)],se.prototype,"colormapMaxIndex",void 0);let Lt=class extends G{constructor(){super(...arguments),this.type="RasterColorizerLUTShader"}_colorize(e){const t=this._getPixel(e);return Fe(t,new d(1),this.colormapConfig,!1)}};u([m(se)],Lt.prototype,"colormapConfig",void 0);function Et(i){const e=new w(0,-.3333333333333333,.6666666666666666,-1),t=j(st(i.y,i.z),new w(i.zy,e.wz),new w(i.yz,e.xy)),s=j(st(i.x,t.x),new w(t.xyw,i.x),new w(i.x,t.yzx)),a=s.x.subtract(it(s.w,s.y)),r=new d(1e-10),o=s.w.subtract(s.y),n=a.multiply(6).add(r),l=O(o.divide(n).add(s.z)),c=s.x.add(r),p=it(a.divide(c),new d(1));return new b(l,p,s.x)}function Wt(i){const e=new w(1,.6666666666666666,.3333333333333333,3),t=O(pt(i.xxx.add(e.xyz)).multiply(6).subtract(e.www)),s=N(t.subtract(e.xxx),new b(0,0,0),new b(1));return i.z.multiply(W(e.xxx,s,i.y))}let H=class extends z{};function U(i){const e=O(i),t=V(e,new _(1,1)).multiply(e),s=new d(2).subtract(e),a=V(new d(1),e).multiply(s);return t.add(a)}function Ve(i,e,t){const s=new d(1).divide(t),a=S(i,U(s.multiply(new _(-1,-1)).add(e))),r=S(i,U(s.multiply(new _(0,-1)).add(e))),o=S(i,U(s.multiply(new _(1,-1)).add(e))),n=S(i,U(s.multiply(new _(-1,0)).add(e))),l=S(i,U(e)),c=S(i,U(s.multiply(new _(1,0)).add(e))),p=S(i,U(s.multiply(new _(-1,1)).add(e))),h=S(i,U(s.multiply(new _(0,1)).add(e))),f=S(i,U(s.multiply(new _(1,1)).add(e))),g=new w(a.a,r.a,o.a,n.a),y=new w(c.a,p.a,h.a,f.a),x=g.multiply(y),T=x.xy.multiply(x.zw),P=T.x.multiply(T.y).multiply(l.a),R=new X(new d(0),10);return R[0]=a.r,R[1]=r.r,R[2]=o.r,R[3]=n.r,R[4]=l.r,R[5]=c.r,R[6]=p.r,R[7]=h.r,R[8]=f.r,R[9]=P,R}function ft(i,e){const t=new w(i[5],i[3],i[7],i[1]).multiply(2),s=new b(i[2],t[0],i[8]),a=new b(i[0],t[1],i[6]),r=E(s.subtract(a),new b(1)),o=new b(i[6],t[2],i[8]),n=new b(i[0],t[3],i[2]),l=E(o.subtract(n),new b(1));return new _(r,l).multiply(e)}function Nt(i,e,t){const{factor:s}=e,a=ft(i,s),r=te(E(a,a).add(1)),o=i[9],{sinZsinAs:n,sinZcosAs:l,cosZs:c,weights:p}=e;if(!t){const y=Je({sinZsinA:n[0],sinZcosA:l[0],cosZ:c[0],weights:new d(1),dzxy:a,dzd:r});return new w(y,y,y,o)}const h=Je({sinZsinA:new b(n[0],n[1],n[2]),sinZcosA:new b(l[0],l[1],l[2]),cosZ:new b(c[0],c[1],c[2]),weights:new b(p[0],p[1],p[2]),dzxy:a,dzd:r}),f=Je({sinZsinA:new b(n[3],n[4],n[5]),sinZcosA:new b(l[3],l[5],l[5]),cosZ:new b(c[3],c[4],c[5]),weights:new b(p[3],p[4],p[5]),dzxy:a,dzd:r}),g=E(h.add(f),new b(1));return new w(g,g,g,o)}function Je(i){const e=i.sinZsinA.multiply(i.dzxy.y),t=i.sinZcosA.multiply(i.dzxy.x),s=e.subtract(t),a=i.cosZ.add(s).divide(i.dzd);return a.multiply(V(new d(0),a)).multiply(i.weights)}function Zt(i,e){const{pixelSizeFactor:t}=i,s=[i.factor[0]/e[0],i.factor[1]/e[1]];if(t>0){const{zFactor:a,pixelSizePower:r,gcsFactor:o}=i,n=e[0]*o,l=e[1]*o;s[0]=(a+n**r*t)/(8*n),s[1]=(a+l**r*t)/(8*l)}return s}u([m(X.ofType(d,6))],H.prototype,"sinZcosAs",void 0),u([m(X.ofType(d,6))],H.prototype,"sinZsinAs",void 0),u([m(X.ofType(d,6))],H.prototype,"cosZs",void 0),u([m(X.ofType(d,6))],H.prototype,"weights",void 0),u([m(d)],H.prototype,"minValue",void 0),u([m(d)],H.prototype,"maxValue",void 0),u([m(_)],H.prototype,"factor",void 0);let Re=class extends G{constructor(){super(...arguments),this.type="RasterColorizerShadedReliefShader",this.applyColormap=!1,this.isMultidirectional=!1}_colorize(e){const{texture:t}=this.config,s=Ve(t,e,this.config.srcImageSize),a=Nt(s,this.hillshadeConfig,this.isMultidirectional);if(!this.applyColormap)return new w(a.x,a.x,a.x,a.a);const{minValue:r,maxValue:o}=this.hillshadeConfig,n=this._getPixel(e),l=o.subtract(r),c=n.r.subtract(r),p=N(c.divide(l),new d(0),new d(1)),h=Fe(new w(p,p,p,1),new d(255),this.colormapConfig),f=Et(h.xyz),g=Wt(new b(f.xy,a.x));return new w(g,h.a.multiply(a.a))}};u([v],Re.prototype,"applyColormap",void 0),u([v],Re.prototype,"isMultidirectional",void 0),u([m(H)],Re.prototype,"hillshadeConfig",void 0),u([he(se)],Re.prototype,"colormapConfig",void 0);let Q=class extends z{};function Ji(i,e){const{minCutOff:t,maxCutOff:s,factor:a,minOutput:r}=e;return N(i,t,s).subtract(t).multiply(a).add(r)}function Ki(i,e){const{minCutOff:t,maxCutOff:s,minOutput:a,maxOutput:r,gamma:o,gammaCorrection:n}=e,l=N(i,t,s).subtract(t),c=s.subtract(t),p=l.divide(c),h=V(new d(1),o),f=L(o.subtract(1)),g=r.subtract(a),y=new b(1),x=J(y.divide(g),p.multiply(n)),T=be(h.multiply(f).multiply(x)),P=J(p,y.divide(o)),R=T.multiply(g).multiply(P).add(a);return N(R,a,r)}function Ht(i,e,t,s=255){const a=t?Ki(i.rgb,e).divide(s):Ji(i.rgb,e);return new w(a,i.a)}u([m(d)],Q.prototype,"minOutput",void 0),u([m(d)],Q.prototype,"maxOutput",void 0),u([m(b)],Q.prototype,"minCutOff",void 0),u([m(b)],Q.prototype,"maxCutOff",void 0),u([m(b)],Q.prototype,"factor",void 0),u([m(b)],Q.prototype,"gamma",void 0),u([m(b)],Q.prototype,"gammaCorrection",void 0);let ne=class extends G{constructor(){super(...arguments),this.type="RasterColorizerStretchShader",this.isMultiband=!0,this.applyColormap=!1,this.useGamma=!1,this.noOp=!1}_colorize(e){const t=this._getPixel(e);if(this.noOp)return t;let s=Ht(t,this.stretchConfig,this.useGamma);if(this.isMultiband)return s;if(s=new w(s.rrr,s.a),this.applyColormap){const a=this.useGamma?255:1;s=Fe(s,new d(a),this.colormapConfig)}return s}};u([v],ne.prototype,"isMultiband",void 0),u([v],ne.prototype,"applyColormap",void 0),u([v],ne.prototype,"useGamma",void 0),u([v],ne.prototype,"noOp",void 0),u([m(Q)],ne.prototype,"stretchConfig",void 0),u([he(se)],ne.prototype,"colormapConfig",void 0);let er=class extends dt{constructor(){super(...arguments),this.name="BrushRasterColorizer",this.type=k.RasterColorizer,this.shaders={lut:new Lt,stretch:new ne,shadedRelief:new Re}}render(e,t){for(const s of t.bitmaps){if(!s.source||s.suspended)continue;e.timeline.begin(this.name);const{painter:a}=e;a.setPipelineState({depth:!1,stencil:{test:{mask:255,ref:s.stencilRef,compare:ys.EQUAL,op:{fail:Xe.KEEP,zFail:Xe.KEEP,zPass:Xe.KEEP}},write:!1},color:{write:[!0,!0,!0,!0],blendMode:"composite"}}),s.updateTexture(e),s.processedTexture||s.updateProcessedTexture();const{type:r}=s.symbolizerParameters,o=r==="stretch"?this._getStretchOptions(s):r==="lut"?this._getLutOptions(s):this._getShadedReliefOptions(s);s.interpolation!=="bilinear"||e.context.capabilities.textureFloatLinear||(o.defines.bilinear=!0),a.submitDrawMesh(e.context,o,a.quadMesh),e.timeline.end(this.name)}}_getLutOptions(e){const{config:t,projectionConfig:s,colormapConfig:a,pixelMaskConfig:r,projectionDefines:o}=this._getCommonConfig(e),n=this._getInterpolationDefines("nearest",!1);return{shader:this.shaders.lut,uniforms:{projectionConfig:s,config:t,colormapConfig:a,pixelMaskConfig:r},defines:{...o,...n,applyPixelMask:!!r},optionalAttributes:null,useComputeBuffer:!1}}_getStretchOptions(e){const t=e.symbolizerParameters,{config:s,projectionConfig:a,colormapConfig:r,pixelMaskConfig:o,projectionDefines:n}=this._getCommonConfig(e),l=this._getInterpolationDefines(e.interpolation,t.bandCount===1);return{shader:this.shaders.stretch,uniforms:{projectionConfig:a,config:s,stretchConfig:t,colormapConfig:r,pixelMaskConfig:o},defines:{...n,...l,isMultiband:t.bandCount>1,applyColormap:!!r,useGamma:t.useGamma,noOp:e.isRendereredSource&&!e.processed,applyPixelMask:!!o},optionalAttributes:null,useComputeBuffer:!1}}_getShadedReliefOptions(e){const t=e.symbolizerParameters,{config:s,projectionConfig:a,colormapConfig:r,pixelMaskConfig:o,projectionDefines:n}=this._getCommonConfig(e),l=this._getInterpolationDefines(e.interpolation,!0);return{shader:this.shaders.shadedRelief,uniforms:{projectionConfig:a,config:s,hillshadeConfig:t,colormapConfig:r,pixelMaskConfig:o},defines:{...n,...l,isMultidirectional:t.hillshadeType>0,applyColormap:!!r,applyPixelMask:!!o},optionalAttributes:null,useComputeBuffer:!1}}_getCommonConfig(e){const{coordScale:t,computedOpacity:s,transforms:a}=e,{names:r,textures:o}=e.getTextures({useProcessedTexture:e.processed}),n=o[r.indexOf("u_image")],l=e.getRasterTextureSize(),c={texture:{texture:n,unit:0},dvsMat3:a.displayViewScreenMat3,coordScale:t,srcImageSize:l,opacity:s},p=o[r.indexOf("u_transformGrid")],{transformGrid:h}=e,f=!(!p||!h),g=f?{transformTexture:{texture:p,unit:2},targetImageSize:[e.width,e.height],transformSpacing:h.spacing,transformGridSize:h.size}:void 0,y=o[r.indexOf("u_colormap")],{colormap:x,colormapOffset:T}=e.symbolizerParameters,P=y&&x?{colormapTexture:{texture:y,unit:1},colormapOffset:T??0,colormapMaxIndex:x.length/4-1}:void 0,R=o[r.indexOf("u_mask")];return{config:c,projectionConfig:g,colormapConfig:P,pixelMaskConfig:R?{maskTexture:{texture:R,unit:3}}:void 0,projectionDefines:{applyProjection:f,lookupProjection:f&&h.spacing[0]===1}}}_getInterpolationDefines(e,t){const s=e==="bilinear"&&t;return{bilinear:s,bicubic:e==="cubic",nearestOnEdge:s}}};function Qt(i,e){const t=new ws;return t.width=i,t.height=e,t.internalFormat=bs.RGBA32F,t.samplingMode=Ke.NEAREST,t.dataType=xs.FLOAT,t.isImmutable=!0,t.wrapMode=_s.CLAMP_TO_EDGE,t}function tr(i,e,t){const s=Qt(e,t);return new vs(i,s)}function Xt(i,e,t){const s=Qt(e,t);return new ki(i,s)}let F=class extends dt{shutdown(e){var t;super.shutdown(e),(t=this._fbo)==null||t.dispose(),this._fbo=void 0}render(e,t){const{rasterFunction:s}=e;if(!s)return;const{context:a}=e,r="indexedColormap"in s.parameters?tt(a,s.parameters.indexedColormap):void 0,o=s.name==="Reproject",n=a.getBoundFramebufferObject(),l=a.getViewport();for(const c of t.bitmaps){const p=o?!(c.rasterTexture&&c.projected):!c.processed;if(!c.source||!p||c.suspended)continue;e.timeline.begin(this.name);const{painter:h}=e;h.setPipelineState({depth:!1,stencil:{test:!1,write:!1},color:{write:[!0,!0,!0,!0],blendMode:"custom",blendParameters:{srcRGB:De.ONE,dstRGB:De.ZERO,srcAlpha:De.ONE,dstAlpha:De.ZERO}}}),o||(c.processedTexture=A(c.processedTexture)),c.updateTexture(e);const[f,g]=c.getRasterTextureSize(o),y=f===ce&&g===ce,x=y?t.processorFbo:Xt(a,f,g);a.bindFramebuffer(x),a.setViewport(0,0,x.width,x.height),this._process(e,c,r);const T=tr(e.context,f,g);if(x.copyToTexture(0,0,f,g,0,0,T),o)c.rasterTexture=T;else{const P=e.hasBranches?s.id:0;c.functionTextures[P]=T}y||x.dispose(),e.timeline.end(this.name)}r==null||r.dispose(),a.bindFramebuffer(n),a.setViewport(l.x,l.y,l.width,l.height)}_getCommonConfig(e,t){var p,h;const{rasterFunction:s,hasBranches:a}=e,{raster:r,rasters:o}=s.parameters,n=a?(r==null?void 0:r.id)??((h=(p=o==null?void 0:o.filter((f=>f.name!=="Constant")))==null?void 0:p[0])==null?void 0:h.id)??-1:0,l=t.functionTextures[n]??t.rasterTexture,c=s.name==="Reproject";return{texture:{texture:l,unit:0},srcImageSize:t.getRasterTextureSize(c)}}_getMultipleInputConfig(e,t){return t!=null&&t.length?t.length===2?{twoRasterConfig:this._getTwoInputConfig(t,e)}:t.length===3?{threeRasterConfig:this._getThreeInputConfig(t,e)}:{}:{}}_getConstantCount(e){return(e==null?void 0:e.filter((t=>t.name==="Constant")).length)??0}_getTextures(e,t){return e.filter((s=>s.name!=="Constant")).map((s=>s.id!=null&&s.name!=="Identity"?t.functionTextures[s.id]:t.rasterTexture))}_getTwoInputConfig(e,t){const s=this._getTextures(e,t),a=s[1]?{texture:s[1],unit:1}:void 0,r=e.findIndex((n=>n.name==="Constant")),o=r===0?new Float32Array([0,1,0,1,0,0,0,0,0]):new Float32Array([1,0,0,0,1,0,0,0,0]);return{image1:a,image1Const:r>-1?e[r].parameters.value:0,imageSwap:o}}_getThreeInputConfig(e,t){const s=this._getTextures(e,t);let a=0,r=0,o=new Float32Array([1,0,0,0,1,0,0,0,1]);const n=s[1]?{texture:s[1],unit:1}:void 0,l=s[2]?{texture:s[2],unit:2}:void 0,c=[];if(e.forEach(((p,h)=>p.name==="Constant"&&c.push(h))),c.length===1)a=e[c[0]].parameters.value,o=c[0]===0?new Float32Array([0,1,0,0,0,1,1,0,0]):c[0]===1?new Float32Array([1,0,0,0,0,1,0,1,0]):new Float32Array([1,0,0,0,1,0,0,0,1]);else if(c.length===2){a=e[c[0]].parameters.value,r=e[c[1]].parameters.value;const p=e.findIndex((h=>h.name!=="Constant"));o=p===0?new Float32Array([1,0,0,0,1,0,0,0,1]):p===1?new Float32Array([0,1,0,1,0,0,0,0,1]):new Float32Array([0,0,1,1,0,0,0,1,0])}return{image1:n,image2:l,image1Const:a,image2Const:r,imageSwap:o}}},Yt=class extends Ot{};u([Bt(0,_)],Yt.prototype,"position",void 0);let sr=class extends Dt{},rt=class extends z{};u([m(ie)],rt.prototype,"texture",void 0),u([m(_)],rt.prototype,"srcImageSize",void 0);let $=class extends Ft{vertex(e){return{uv:e.position,glPosition:new w(zi(e.position),0,1)}}fragment(e){const t=new Vt,s=Gt(e.uv),a=this._process(s);return t.fragColor=new w(a.rgb,1).multiply(a.a),t}_getPixel(e){return Ut(e,this.config)}};u([m(rt)],$.prototype,"config",void 0),u([Ee(0,We(Yt))],$.prototype,"vertex",null),u([Ee(0,We(sr))],$.prototype,"fragment",null);let Jt=class extends z{};u([m(_)],Jt.prototype,"cellSize",void 0);let Kt=class extends ${constructor(){super(...arguments),this.type="AspectShader"}_process(e){const{texture:t}=this.config,s=Ve(t,e,this.config.srcImageSize),a=new _(1).divide(this.aspectConfig.cellSize.multiply(8)),{x:r,y:o}=ft(s,a),n=we(o),l=s[9].multiply(L(O(r).add(O(n)))),c=O(L(r)),p=new d(3.14159265359),h=new d(0),f=V(h,n).multiply(.5).multiply(p).add(V(n,h).multiply(1.5).multiply(p)),g=At(new d(2.5).multiply(p).add(Ne(n,we(r))),new d(2).multiply(p)),y=W(f,g,c).multiply(180).divide(p);return new w(y,y,y,l)}};u([m(Jt)],Kt.prototype,"aspectConfig",void 0);let ir=class extends F{constructor(){super(...arguments),this.name="RasterAspectProcessor",this.type=k.Aspect,this.shaders={aspect:new Kt}}_process(e,t){const s={cellSize:t.getRasterCellSize()},a=this._getCommonConfig(e,t),r={shader:this.shaders.aspect,uniforms:{config:a,aspectConfig:s},defines:{},optionalAttributes:null,useComputeBuffer:!1},{painter:o,context:n}=e;o.submitDrawMesh(n,r,o.quadMesh)}};function M(i){const e=L(i),t=i.add(O(e).subtract(1));return e.multiply(e).divide(t)}function ve(i){return new w(Y(i.rgb.add(.5)),i.a)}function es(i,e){return V(e.x,i).multiply(V(i,e.y))}function rr(i,e,t){const s=new b(i);let a=new b(0,0,0),r=new d(0);for(let o=0;o<t/3;o++){const n=9*o,l=new b(e[n],e[n+3],e[n+6]),c=new b(e[n+1],e[n+4],e[n+7]),p=V(l,s).multiply(V(s,c)),h=new b(e[n+2],e[n+5],e[n+8]);r=W(r,h.x,p.x),r=W(r,h.y,p.y),r=W(r,h.z,p.z),a=a.add(p)}return{mapValue:r,includeMask:L(E(a,new b(1,1,1)))}}class ts extends z{}u([m(_e)],ts.prototype,"bandIndexMat3",void 0);let ss=class extends z{};u([m(b)],ss.prototype,"adjustments",void 0);let Se=class extends ${constructor(){super(...arguments),this.type="BandArithmeticShader",this.isOutputRounded=!1}_process(e){const t=this._getPixel(e),s=this.bandArithmeticConfig.bandIndexMat3.multiply(t.rgb),a=this._processIndex(s),r=new w(a,a,a,t.a);return this.isOutputRounded?ve(r):r}_processIndex(e){var r;const{r:t,g:s}=e,a=(r=this.adjustmentConfig)==null?void 0:r.adjustments;switch(this.indexType){case"ndxi":{const o=t.subtract(s),n=t.add(s);return o.multiply(M(n))}case"sr":return t.multiply(M(s));case"ci":return t.multiply(M(s)).subtract(1);case"savi":{const{x:o}=a,n=t.subtract(s),l=t.add(s).add(o);return n.multiply(M(l)).multiply(o.add(1))}case"tsavi":{const{x:o,y:n,z:l}=a,c=l.multiply(o.multiply(o).add(1)).subtract(n.multiply(o)),p=o.multiply(t.subtract(o.multiply(s)).subtract(n)),h=n.multiply(t).add(s).add(c);return p.multiply(M(h))}case"msavi":{const o=t.multiply(2).add(1),n=o.multiply(o).subtract(t.subtract(s).multiply(8));return o.subtract(te(n)).multiply(.5)}case"gemi":{const o=t.multiply(t).subtract(s.multiply(s)).multiply(2).add(t.multiply(1.5)).add(s.multiply(.5)),n=t.add(s).add(.5),l=o.multiply(M(n)),c=l.multiply(be(l.multiply(.25))),p=s.subtract(.125).multiply(M(be(s)));return c.subtract(p)}case"pvi":{const{x:o,y:n}=a,l=te(o.multiply(o).add(1));return t.subtract(s.multiply(o)).subtract(n).multiply(M(l))}case"vari":{const o=e.g.subtract(e.r),n=e.g.add(e.r).subtract(e.b);return o.multiply(M(n))}case"rtvicore":return t.subtract(s).multiply(100).subtract(t.subtract(e.b).multiply(10));case"bai":{const o=J(new d(.1).subtract(s),new d(2)),n=J(new d(.06).subtract(t),new d(2));return M(o.add(n))}case"evi":{const o=e.b,n=t.add(s.multiply(6)).subtract(o.multiply(7.5)).add(1);return t.subtract(s).multiply(2.5).multiply(M(n))}case"wndwi":{const{r:o,g:n,b:l}=e,c=a.x,p=c.multiply(n),h=c.multiply(l),f=o.add(p).add(l).subtract(h);return o.subtract(p).subtract(l).add(h).multiply(M(f))}case"mtvi":{const o=e.b,n=J(t.multiply(2).add(1),new d(2)),l=t.multiply(6).subtract(te(s).multiply(5)),c=te(n.subtract(l).subtract(.5)),p=t.subtract(o).multiply(1.2),h=s.subtract(o).multiply(2.5);return p.subtract(h).multiply(1.5).multiply(M(c))}default:return t}}};u([v],Se.prototype,"indexType",void 0),u([v],Se.prototype,"isOutputRounded",void 0),u([m(ts)],Se.prototype,"bandArithmeticConfig",void 0),u([he(ss)],Se.prototype,"adjustmentConfig",void 0);let ar=class extends F{constructor(){super(...arguments),this.name="RasterBandArithmeticProcessor",this.type=k.BandArithmetic,this.shaders={bandArithmetic:new Se}}_process(e,t){const s=e.rasterFunction.parameters,a={indexType:s.indexType,isOutputRounded:s.isOutputRounded},r={bandIndexMat3:s.bandIndexMat3},o=s.adjustments?{adjustments:[...s.adjustments]}:void 0,n=this._getCommonConfig(e,t),l={shader:this.shaders.bandArithmetic,uniforms:{config:n,bandArithmeticConfig:r,adjustmentConfig:o},defines:a,optionalAttributes:null,useComputeBuffer:!1},{painter:c,context:p}=e;c.submitDrawMesh(p,l,c.quadMesh)}},is=class extends ${constructor(){super(...arguments),this.type="ColormapToRGBShader"}_process(e){const t=this._getPixel(e),s=Fe(t,new d(1),this.colormapConfig,!1);return new w(s.xyz.multiply(255),s.a)}};u([m(se)],is.prototype,"colormapConfig",void 0);class or extends F{constructor(){super(...arguments),this.name="RasterColormapToRGBProcessor",this.type=k.ColormapToRGB,this.shaders={colormapToRGB:new is}}_process(e,t,s){const a=e.rasterFunction.parameters,r={colormapTexture:{texture:s,unit:1},colormapOffset:a.offset,colormapMaxIndex:a.indexedColormap.length/4-1},o=this._getCommonConfig(e,t),n={shader:this.shaders.colormapToRGB,uniforms:{config:o,colormapConfig:r},defines:{},optionalAttributes:null,useComputeBuffer:!1},{painter:l,context:c}=e;l.submitDrawMesh(c,n,l.quadMesh)}}let Ge=class extends z{};u([m(ie)],Ge.prototype,"image1",void 0),u([m(d)],Ge.prototype,"image1Const",void 0),u([m(_e)],Ge.prototype,"imageSwap",void 0);let de=class extends z{};u([m(ie)],de.prototype,"image1",void 0),u([m(ie)],de.prototype,"image2",void 0),u([m(d)],de.prototype,"image1Const",void 0),u([m(d)],de.prototype,"image2Const",void 0),u([m(_e)],de.prototype,"imageSwap",void 0);const gt=i=>{class e extends i{constructor(){super(...arguments),this.constantCount=0,this.imageCount=1}_getRasterValues(s){const{imageCount:a}=this;if(a===1){const r=S(this.config.texture,s);return{a:r.r,b:r.g,c:r.b,alpha:r.a}}if(a===2){const r=this._getTwoValues(s);return{a:r.a,b:r.b,c:r.b,alpha:r.alpha}}return this._getThreeValues(s)}_getTwoValues(s){const a=S(this.config.texture,s);if(this.constantCount===1){const{imageSwap:n,image1Const:l}=this.twoRasterConfig,c=n.multiply(new b(a.r,l,0));return{a:c.x,b:c.y,alpha:a.a}}const{image1:r}=this.twoRasterConfig,o=S(r,s);return{a:a.r,b:o.r,alpha:a.a.multiply(o.a)}}_getThreeValues(s){const a=S(this.config.texture,s),{imageSwap:r,image1:o,image2:n,image1Const:l,image2Const:c}=this.threeRasterConfig;if(this.constantCount===2){const f=r.multiply(new b(a.r,l,c));return{a:f.x,b:f.y,c:f.z,alpha:a.a}}if(this.constantCount===1){const f=S(o,s),g=r.multiply(new b(a.r,f.r,l));return{a:g.x,b:g.y,c:g.z,alpha:a.a.multiply(f.a)}}const p=S(o,s),h=S(n,s);return{a:a.r,b:p.r,c:h.r,alpha:a.a.multiply(p.a).multiply(h.a)}}}return u([v],e.prototype,"constantCount",void 0),u([v],e.prototype,"imageCount",void 0),u([he(Ge)],e.prototype,"twoRasterConfig",void 0),u([he(de)],e.prototype,"threeRasterConfig",void 0),e};let nr=class extends gt($){constructor(){super(...arguments),this.type="CompositeBandShader"}_process(e){const{a:t,b:s,c:a,alpha:r}=this._getRasterValues(e);return new w(t,s,a,r)}},lr=class extends F{constructor(){super(...arguments),this.name="RasterCompositeBandProcessor",this.type=k.CompositeBand,this.shaders={compositeBand:new nr}}_process(e,t){const{rasters:s}=e.rasterFunction.parameters,a={constantCount:this._getConstantCount(s),imageCount:(s==null?void 0:s.length)??1},r=this._getMultipleInputConfig(t,s),o=this._getCommonConfig(e,t),n={shader:this.shaders.compositeBand,uniforms:{config:o,...r},defines:a,optionalAttributes:null,useComputeBuffer:!1},{painter:l,context:c}=e;l.submitDrawMesh(c,n,l.quadMesh)}};class yt extends z{}u([m(_)],yt.prototype,"domainRange",void 0);class Ue extends gt($){constructor(){super(...arguments),this.type="LocalShader",this.isOutputRounded=!1}_process(e){if(this.operationName==="conditional")return this._conditional(e);const{a:t,b:s,alpha:a}=this._getRasterValues(e),{value:r,alpha:o}=this._compute(t,s,a);return this._processResult(r,o)}_processResult(e,t){const s=es(e,this.domainRangeConfig.domainRange),a=new w(e,e,e,t).multiply(s);return this.isOutputRounded?ve(a):a}_compute(e,t,s){const{operationName:a}=this;let r;switch(a){case"plus":r=e.add(t);break;case"minus":r=e.subtract(t);break;case"times":r=e.multiply(t);break;case"divide":case"floatdivide":r=e.multiply(M(t)),s=s.multiply(D(O(L(t))));break;case"floordivide":r=Y(e.multiply(M(t))),s=s.multiply(D(O(L(t))));break;case"square":r=e.multiply(e);break;case"sqrt":r=te(e);break;case"power":r=J(e,t);break;case"ln":r=j(oe(e,new d(0)),Ci(e),new d(0)),s=s.multiply(this._isAboveZero(e));break;case"log10":r=j(oe(e,new d(0)),Ye(e).multiply(M(Ye(new d(10)))),new d(0)),s=s.multiply(this._isAboveZero(e));break;case"log2":r=j(oe(e,new d(0)),Ye(e),new d(0)),s=s.multiply(this._isAboveZero(e));break;case"exp":r=vi(e);break;case"exp10":r=J(new d(10),e);break;case"exp2":r=J(new d(2),e);break;case"rounddown":r=Y(e);break;case"roundup":r=_i(e);break;case"int":r=L(e).multiply(Y(O(e)));break;case"mod":r=At(e,t);break;case"negate":r=we(e);break;case"abs":r=O(e);break;case"acos":{const o=this._isAbsBiggerThanOne(e);r=j(o,new d(0),xi(e)),s=j(o,new d(0),s);break}case"acosh":r=bi(e);break;case"asin":{const o=this._isAbsBiggerThanOne(e);r=j(o,new d(0),wi(e)),s=j(o,new d(0),s);break}case"asinh":r=yi(e);break;case"atan":r=Ne(e);break;case"atanh":{const o=this._isAbsBiggerThanOne(e);r=j(o,new d(0),gi(e)),s=j(o,new d(0),s);break}case"atan2":r=Ne(e,t);break;case"cos":r=fi(e);break;case"cosh":r=mi(e);break;case"sin":r=di(e);break;case"sinh":r=pi(e);break;case"tan":r=hi(e);break;case"tanh":r=ci(e);break;case"bitwiseand":r=new d(ui(new I(e),new I(t)));break;case"bitwiseor":r=new d(li(new I(e),new I(t)));break;case"bitwiseleftshift":r=new d(ni(new I(e),new I(t)));break;case"bitwiserightshift":r=new d(oi(new I(e),new I(t)));break;case"bitwisenot":r=new d(ai(new I(e)));break;case"bitwisexor":r=new d(ri(new I(e),new I(t)));break;case"booleanand":r=D(ii(ae(e,new d(0)),ae(t,new d(0))));break;case"booleanor":r=D(si(ae(e,new d(0)),ae(t,new d(0))));break;case"booleannot":r=D(ye(e,new d(0)));break;case"booleanxor":r=D(ti(ae(e,new d(0)),ae(t,new d(0))));break;case"greaterthan":r=D(oe(e,t));break;case"greaterthanequal":r=D(ei(e,t));break;case"lessthan":r=D(st(e,t));break;case"lessthanequal":r=D(Mt(e,t));break;case"equalto":r=D(ye(e,t));break;case"notequal":r=D(ae(e,t));break;case"isnull":r=D(ye(s,new d(0))),s=new d(1);break;case"setnull":{const o=D(ye(e,new d(0)));r=o.multiply(t),s=s.multiply(o);break}default:r=e}return{value:r,alpha:s}}_conditional(e){const{a:t,b:s,c:a,alpha:r}=this._getRasterValues(e),o=new d(O(L(t))),n=W(a,s,o);return this._processResult(n,r)}_isAboveZero(e){return D(oe(e,new d(0)))}_isAbsBiggerThanOne(e){return oe(O(e),new d(1))}}u([v],Ue.prototype,"operationName",void 0),u([v],Ue.prototype,"isOutputRounded",void 0),u([m(yt)],Ue.prototype,"domainRangeConfig",void 0);let qe=class extends gt($){constructor(){super(...arguments),this.type="ComputeChangeShader",this.isOutputRounded=!1}_process(e){const{a:t,b:s,alpha:a}=this._getRasterValues(e);let r=t.subtract(s);this.method==="relative-difference"&&(r=r.multiply(M(mt(O(t),O(s)))));const o=es(r,this.domainRangeConfig.domainRange),n=new w(r,r,r,a).multiply(o);return this.isOutputRounded?ve(n):n}};u([v],qe.prototype,"method",void 0),u([v],qe.prototype,"isOutputRounded",void 0),u([m(yt)],qe.prototype,"domainRangeConfig",void 0);let ur=class extends F{constructor(){super(...arguments),this.name="RasterComputeChangeProcessor",this.type=k.ComputeChange,this.shaders={computeChange:new qe}}_process(e,t){const s=e.rasterFunction.parameters,{rasters:a}=s,r={constantCount:this._getConstantCount(a),imageCount:a.length,method:s.method,isOutputRounded:s.isOutputRounded},o={domainRange:s.domainRange},{twoRasterConfig:n}=this._getMultipleInputConfig(t,a),l=this._getCommonConfig(e,t),c={shader:this.shaders.computeChange,uniforms:{config:l,domainRangeConfig:o,twoRasterConfig:n},defines:r,optionalAttributes:null,useComputeBuffer:!1},{painter:p,context:h}=e;p.submitDrawMesh(h,c,p.quadMesh)}},at=class extends z{};u([m(d)],at.prototype,"contrastOffset",void 0),u([m(d)],at.prototype,"brightnessOffset",void 0);let rs=class extends ${constructor(){super(...arguments),this.type="ContrastBrightnessShader"}_process(e){const{rgb:t,a:s}=this._getPixel(e),{contrastOffset:a,brightnessOffset:r}=this.contrastBrightnessConfig,o=new d(255),n=new d(128),l=t.multiply(200),c=o.multiply(100),p=o.multiply(2).multiply(r),h=l.subtract(c).add(p),f=Ti([ye(a,new d(-100)),new b(n)],[ye(a,new d(100)),L(h).add(1).divide(2).multiply(o)],[oe(a,new d(0)),h.divide(new d(100).subtract(a).multiply(2)).add(n)],[!0,h.multiply(a.add(100)).divide(2e4).add(n)]);return ve(new w(f,s))}};u([m(at)],rs.prototype,"contrastBrightnessConfig",void 0);class cr extends F{constructor(){super(...arguments),this.name="RasterContrastBrightnessProcessor",this.type=k.ContrastBrightness,this.shaders={contrastBrightness:new rs}}_process(e,t){const s=this._getCommonConfig(e,t),a=e.rasterFunction.parameters,r={shader:this.shaders.contrastBrightness,uniforms:{config:s,contrastBrightnessConfig:a},defines:{},optionalAttributes:null,useComputeBuffer:!1},{painter:o,context:n}=e;o.submitDrawMesh(n,r,o.quadMesh)}}let ot=class extends z{};u([m(Si.ofType(d,5,5,!0))],ot.prototype,"kernel",void 0),u([m(_)],ot.prototype,"clampRange",void 0);let je=class extends ${constructor(){super(...arguments),this.type="ConvolutionShader",this.rows=3,this.cols=3}_process(e){const{rows:t,cols:s}=this,a=new _(Math.floor(t/2),Math.floor(s/2)),{texture:r,srcImageSize:o}=this.config,n=new d(1).divide(o),{kernel:l}=this.convolutionConfig,c=Ri(l,{initialValue:new w(0,0,0,1),xRange:[0,t],yRange:[0,s],callback:(h,f,g,y)=>{const x=new _(new d(g),new d(y)).subtract(a).multiply(n),T=S(r,U(e.add(x))),P=T.rgb.multiply(f).add(h.rgb),R=T.a.multiply(h.a);return new w(P,R)}}),{clampRange:p}=this.convolutionConfig;return new w(N(c.rgb,p.x,p.y),1).multiply(c.a)}};u([v],je.prototype,"rows",void 0),u([v],je.prototype,"cols",void 0),u([m(ot)],je.prototype,"convolutionConfig",void 0);let hr=class extends F{constructor(){super(...arguments),this.name="RasterConvolutionProcessor",this.type=k.Convolution,this.shaders={convolution:new je}}_process(e,t){const s=e.rasterFunction.parameters,a={rows:s.kernelRows,cols:s.kernelCols},r={kernel:[...s.kernel],clampRange:s.clampRange},o=this._getCommonConfig(e,t),n={shader:this.shaders.convolution,uniforms:{config:o,convolutionConfig:r},defines:a,optionalAttributes:null,useComputeBuffer:!1},{painter:l,context:c}=e;l.submitDrawMesh(c,n,l.quadMesh)}},as=class extends z{};u([m(d)],as.prototype,"zlFactor",void 0);let nt=class extends ${constructor(){super(...arguments),this.type="CurvatureShader"}_process(e){const{texture:t}=this.config,s=Ve(t,e,this.config.srcImageSize),a=s[3].add(s[5]).multiply(.5).subtract(s[4]),r=s[1].add(s[7]).multiply(.5).subtract(s[4]),{zlFactor:o}=this.curvatureConfig,{curvatureType:n}=this;let l;if(n==="standard")l=we(o).multiply(a.add(r));else{const c=s[2].subtract(s[0]).add(s[6]).subtract(s[8]).divide(4),p=s[5].subtract(s[3]).divide(2),h=s[1].subtract(s[7]).divide(2),f=p.multiply(p),g=h.multiply(h),y=p.multiply(h),x=o.divide(f.add(g));l=n==="profile"?E(new b(a,r,c),new b(f,g,y)).multiply(x):E(new b(a,r,we(c)),new b(g,f,y)).multiply(we(x))}return new w(l,l,l,s[9])}};u([v],nt.prototype,"curvatureType",void 0),u([m(as)],nt.prototype,"curvatureConfig",void 0);let pr=class extends F{constructor(){super(...arguments),this.name="RasterCurvatureProcessor",this.type=k.Curvature,this.shaders={curvature:new nt}}_process(e,t){const s=e.rasterFunction.parameters,a={curvatureType:s.curvatureType},r=t.getRasterCellSize(),o={zlFactor:200*s.zFactor/r[0]/r[1]},n=this._getCommonConfig(e,t),l={shader:this.shaders.curvature,uniforms:{config:n,curvatureConfig:o},defines:a,optionalAttributes:null,useComputeBuffer:!1},{painter:c,context:p}=e;c.submitDrawMesh(p,l,c.quadMesh)}},os=class extends z{};u([m(_e)],os.prototype,"bandIndexMat3",void 0);let ns=class extends ${constructor(){super(...arguments),this.type="ExtractBandShader"}_process(e){const t=this._getPixel(e),s=this.extractBandConfig.bandIndexMat3.multiply(t.rgb);return new w(s,t.a)}};u([m(os)],ns.prototype,"extractBandConfig",void 0);let dr=class extends F{constructor(){super(...arguments),this.name="RasterExtractBandProcessor",this.type=k.ExtractBand,this.shaders={extractBand:new ns}}_process(e,t){const s={bandIndexMat3:e.rasterFunction.parameters.bandIndexMat3},a=this._getCommonConfig(e,t),r={shader:this.shaders.extractBand,uniforms:{config:a,extractBandConfig:s},defines:{},optionalAttributes:null,useComputeBuffer:!1},{painter:o,context:n}=e;o.submitDrawMesh(n,r,o.quadMesh)}},ls=class extends z{};u([m(_)],ls.prototype,"clampRange",void 0);class me extends ${constructor(){super(...arguments),this.type="FocalStatisticsShader",this.rows=3,this.cols=3,this.fill=!1}_process(e){const t=this._process1(e),s=V(new d(1),t.a);if(!this.fill)return this._clamp(t.rgb,s);const a=this._getPixel(e),r=W(t.rgb,a.rgb,a.a);return this._clamp(r,s)}_clamp(e,t){const{clampRange:s}=this.focalStatisticsConfig;return new w(N(e,s.x,s.y),1).multiply(t)}_process1(e){const{texture:t,srcImageSize:s}=this.config,{rows:a,cols:r}=this,o=new _(Math.floor(a/2),Math.floor(r/2)),n=new d(1).divide(s),l=this._getPixel(e),{statisticsType:c}=this,p=c==="min"||c==="max"?new w(l.rgb,0):new w(0,0,0,0);switch(c){case"min":return this._stat(a,r,p,((h,f,g)=>{const y=new _(new d(f),new d(g)).subtract(o).multiply(n),x=S(t,U(e.add(y))),T=it(h.rgb,x.rgb);return new w(T,h.a.add(x.a))}));case"max":return this._stat(a,r,p,((h,f,g)=>{const y=new _(new d(f),new d(g)).subtract(o).multiply(n),x=S(t,U(e.add(y))),T=mt(h.rgb,x.rgb);return new w(T,h.a.add(x.a))}));case"mean":{const h=this._stat(a,r,p,((g,y,x)=>{const T=new _(new d(y),new d(x)).subtract(o).multiply(n),P=S(t,U(e.add(T))),R=g.rgb.add(P.rgb.multiply(P.a));return new w(R,g.a.add(P.a))})),f=h.rgb.multiply(M(h.a));return new w(f,h.a)}case"stddev":{const h=this._stat(a,r,p,((x,T,P)=>{const R=new _(new d(T),new d(P)).subtract(o).multiply(n),q=S(t,U(e.add(R))),Z=x.rgb.add(q.rgb.multiply(q.a));return new w(Z,x.a.add(q.a))})),f=this._stat(a,r,p,((x,T,P)=>{const R=new _(new d(T),new d(P)).subtract(o).multiply(n),q=S(t,U(e.add(R))),Z=x.rgb.add(q.a.multiply(q.rgb).multiply(q.rgb));return new w(Z,x.a.add(q.a))})),g=M(f.a),y=te(f.subtract(h.multiply(h).multiply(g)).multiply(g));return new w(y.rgb,h.a)}default:return l}}_stat(e=3,t=3,s,a){const r=new I(0).setMutable().setDebugName("StatColIterator"),o=new I(0).setMutable().setDebugName("StatRowIterator"),n=s.setMutable().setDebugName("StatAccumulator"),l=a(n,r,o).setDebugName("StatPredicate");return Pi({iterX:r,iterY:o,accumulator:n},w,l,(({out:p,iterX:h,iterY:f,accumulator:g,subgraph:y})=>`
  for (${f} = 0; ${f} < ${e}; ${f}++) {
    for (${h} = 0; ${h} < ${t}; ${h}++) {
  
    ${y.body}
  
    ${g} = ${y.varName};
    }
  }
  ${p} = ${g};
  `)).setDebugName("statBody")}}u([v],me.prototype,"rows",void 0),u([v],me.prototype,"cols",void 0),u([v],me.prototype,"statisticsType",void 0),u([v],me.prototype,"fill",void 0),u([m(ls)],me.prototype,"focalStatisticsConfig",void 0);class mr extends F{constructor(){super(...arguments),this.name="RasterFocalStatisticsProcessor",this.type=k.Statistics,this.shaders={focalStatistics:new me}}_process(e,t){const s=e.rasterFunction.parameters,a={rows:s.kernelRows,cols:s.kernelCols,statisticsType:s.statisticsType,fill:s.fillNoDataOnly},r={clampRange:s.clampRange},o=this._getCommonConfig(e,t),n={shader:this.shaders.focalStatistics,uniforms:{config:o,focalStatisticsConfig:r},defines:a,optionalAttributes:null,useComputeBuffer:!1},{painter:l,context:c}=e;l.submitDrawMesh(c,n,l.quadMesh)}}class us extends z{}u([m(b)],us.prototype,"weights",void 0);let cs=class extends ${constructor(){super(...arguments),this.type="GrayscaleShader"}_process(e){const t=this._getPixel(e),{weights:s}=this.grayscaleConfig,a=E(s,t.rgb);return new w(a,a,a,t.a)}};u([m(us)],cs.prototype,"grayscaleConfig",void 0);let fr=class extends F{constructor(){super(...arguments),this.name="RasterGrayscaleProcessor",this.type=k.Grayscale,this.shaders={grayscale:new cs}}_process(e,t){const s={weights:e.rasterFunction.parameters.weights},a=this._getCommonConfig(e,t),r={shader:this.shaders.grayscale,uniforms:{config:a,grayscaleConfig:s},defines:{},optionalAttributes:null,useComputeBuffer:!1},{painter:o,context:n}=e;o.submitDrawMesh(n,r,o.quadMesh)}},Ze=class extends ${constructor(){super(...arguments),this.type="HillshadeShader",this.isMultidirectional=!1}_process(e){const{texture:t}=this.config,s=Ve(t,e,this.config.srcImageSize),a=Nt(s,this.hillshadeConfig,this.isMultidirectional);return new w(a.rgb.multiply(255),a.a)}};u([v],Ze.prototype,"isMultidirectional",void 0),u([m(H)],Ze.prototype,"hillshadeConfig",void 0);let gr=class extends F{constructor(){super(...arguments),this.name="RasterHillshadeProcessor",this.type=k.Hillshade,this.shaders={hillshade:new Ze}}_process(e,t){const s=e.rasterFunction.parameters,a={isMultidirectional:s.hillshadeType>0},r=t.getRasterCellSize(),o=Zt(s,r),n={...s,factor:o,minValue:0,maxValue:8e3},l=this._getCommonConfig(e,t),c={shader:this.shaders.hillshade,uniforms:{config:l,hillshadeConfig:n},defines:a,optionalAttributes:null,useComputeBuffer:!1},{painter:p,context:h}=e;p.submitDrawMesh(h,c,p.quadMesh)}},yr=class extends F{constructor(){super(...arguments),this.name="RasterLocalProcessor",this.type=k.Local,this.shaders={local:new Ue}}_process(e,t){var f;const s=e.rasterFunction.parameters,a={constantCount:this._getConstantCount(s.rasters),imageCount:s.imageCount,operationName:s.operationName,isOutputRounded:s.isOutputRounded},r={domainRange:s.domainRange},o=s.operationName==="conditional"?s.rasters:(f=s.rasters)==null?void 0:f.slice(0,2),n=this._getMultipleInputConfig(t,o),l=this._getCommonConfig(e,t),c={shader:this.shaders.local,uniforms:{config:l,domainRangeConfig:r,...n},defines:a,optionalAttributes:null,useComputeBuffer:!1},{painter:p,context:h}=e;p.submitDrawMesh(h,c,p.quadMesh)}};class lt extends z{}u([m(X.ofType(d,6))],lt.prototype,"includedRanges",void 0),u([m(X.ofType(d,xe))],lt.prototype,"noDataValues",void 0);let ut=class extends ${constructor(){super(...arguments),this.type="MaskShader",this.isMultiband=!0}_process(e){const t=this._getPixel(e),s=this._computeNoDataFactor(t.r),a=this._computeRangeFactor(t.rgb);let r;if(this.isMultiband){const o=this._computeNoDataFactor(t.g),n=this._computeNoDataFactor(t.b),l=new b(s,o,n).multiply(a);r=l.x.multiply(l.y).multiply(l.z)}else r=s.multiply(a.x);return t.multiply(r)}_computeNoDataFactor(e){const{noDataValues:t}=this.maskConfig;let s=new b(1);for(let a=0;a<xe/3;a++){const r=3*a,o=new b(t[r+0],t[r+1],t[r+2]),n=O(L(o.subtract(e)));s=s.multiply(n)}return s.x.multiply(s.y).multiply(s.z)}_computeRangeFactor(e){const{includedRanges:t}=this.maskConfig,s=new b(t[0],t[2],t[4]),a=new b(t[1],t[3],t[5]);return V(s,e).multiply(V(e,a))}};u([v],ut.prototype,"isMultiband",void 0),u([m(lt)],ut.prototype,"maskConfig",void 0);let wr=class extends F{constructor(){super(...arguments),this.name="RasterMaskProcessor",this.type=k.Mask,this.shaders={mask:new ut}}_process(e,t){const s=e.rasterFunction.parameters,a={isMultiband:s.bandCount>1},r={includedRanges:[...s.includedRanges],noDataValues:[...s.noDataValues]},o=this._getCommonConfig(e,t),n={shader:this.shaders.mask,uniforms:{config:o,maskConfig:r},defines:a,optionalAttributes:null,useComputeBuffer:!1},{painter:l,context:c}=e;l.submitDrawMesh(c,n,l.quadMesh)}};class hs extends z{}u([m(_e)],hs.prototype,"bandIndexMat3",void 0);class ct extends ${constructor(){super(...arguments),this.type="NDVIShader",this.scaled=!0}_process(e){const t=this._getPixel(e),{r:s,g:a}=this.ndviConfig.bandIndexMat3.multiply(t.rgb),r=s.subtract(a),o=s.add(a),n=r.multiply(M(o));if(!this.scaled)return new w(n,n,n,t.a);const l=Y(n.multiply(100).add(100.5));return new w(l,l,l,t.a)}}u([v],ct.prototype,"scaled",void 0),u([m(hs)],ct.prototype,"ndviConfig",void 0);let br=class extends F{constructor(){super(...arguments),this.name="RasterNDVIProcessor",this.type=k.NDVI,this.shaders={ndvi:new ct}}_process(e,t){const s=e.rasterFunction.parameters,a={scaled:s.scaled},r={bandIndexMat3:s.bandIndexMat3},o=this._getCommonConfig(e,t),n={shader:this.shaders.ndvi,uniforms:{config:o,ndviConfig:r},defines:a,optionalAttributes:null,useComputeBuffer:!1},{painter:l,context:c}=e;l.submitDrawMesh(c,n,l.quadMesh)}},fe=class extends z{};u([m(X.ofType(d,3*xe))],fe.prototype,"rangeMaps",void 0),u([m(X.ofType(d,2*xe))],fe.prototype,"noDataRanges",void 0),u([m(d)],fe.prototype,"unmatchMask",void 0),u([m(d)],fe.prototype,"replacementValue",void 0),u([m(_)],fe.prototype,"clampRange",void 0);class ht extends ${constructor(){super(...arguments),this.type="RemapShader"}_process(e){const t=this._getPixel(e),{rangeMaps:s,unmatchMask:a,clampRange:r,replacementValue:o}=this.remapConfig,{mapValue:n,includeMask:l}=rr(t.r,s,xe),c=this.replaceUnmatched?o:a.multiply(t.r),p=W(c,n,l),h=N(p,r.x,r.y),f=this._computeNoDataFactor(t.rrr).multiply(mt(a,l));return new w(h,h,h,t.a).multiply(f)}_computeNoDataFactor(e){const{noDataRanges:t}=this.remapConfig;let s=new b(0,0,0);for(let a=0;a<xe/3;a++){const r=6*a,o=new b(t[r],t[r+2],t[r+4]),n=new b(t[r+1],t[r+3],t[r+5]);s=s.add(V(o,e).multiply(V(e,n)))}return be(L(E(s,new b(1,1,1))))}}u([m(fe)],ht.prototype,"remapConfig",void 0),u([v],ht.prototype,"replaceUnmatched",void 0);let xr=class extends F{constructor(){super(...arguments),this.name="RasterRemapProcessor",this.type=k.Remap,this.shaders={remap:new ht}}_process(e,t){const s=e.rasterFunction.parameters,a={replaceUnmatched:s.allowUnmatched&&s.replacementValue!=null},r={rangeMaps:[...s.rangeMaps],noDataRanges:[...s.noDataRanges],unmatchMask:s.allowUnmatched?1:0,replacementValue:s.replacementValue??0,clampRange:s.clampRange},o=this._getCommonConfig(e,t),n={shader:this.shaders.remap,uniforms:{config:o,remapConfig:r},defines:a,optionalAttributes:null,useComputeBuffer:!1},{painter:l,context:c}=e;l.submitDrawMesh(c,n,l.quadMesh)}},_r=class extends G{constructor(){super(...arguments),this.type="ReprojectShader"}_colorize(e){return this._getPixel(e)}},vr=class extends F{constructor(){super(...arguments),this.name="RasterReprojectProcessor",this.type=k.Reproject,this.shaders={reproject:new _r}}_process(e,t){const s=e.rasterFunction.parameters,a=this._getInterpolationDefines(t.interpolation,!!s.requireNNEdge),{config:r,projectionConfig:o,projectionDefines:n}=this._getReprojectConfig(t),l={shader:this.shaders.reproject,uniforms:{config:r,projectionConfig:o},defines:{...n,...a,applyPixelMask:!1},optionalAttributes:null,useComputeBuffer:!1},{interpolation:c}=t;t.interpolation="nearest";const{painter:p,context:h}=e;p.submitDrawMesh(h,l,p.quadMesh),t.interpolation=c,t.projected=!0}_getReprojectConfig(e){const{source:t}=e,{names:s,textures:a}=e.getTextures({forProcessing:!0}),r={texture:{texture:a[s.indexOf("u_image")],unit:0},dvsMat3:new Float32Array([2,0,0,0,2,0,-1,-1,0]),coordScale:[1,1],srcImageSize:[t.width,t.height],opacity:1},o=a[s.indexOf("u_transformGrid")],{transformGrid:n}=e,l=!(!o||!n);return{config:r,projectionConfig:l?{transformTexture:{texture:o,unit:1},targetImageSize:[e.width,e.height],transformSpacing:n.spacing,transformGridSize:n.size}:void 0,projectionDefines:{applyProjection:l,lookupProjection:l&&n.spacing[0]===1}}}_getInterpolationDefines(e,t){const s=e==="bilinear"&&t;return{bilinear:s,bicubic:e==="cubic",nearestOnEdge:s}}};class ps extends Ze{constructor(){super(...arguments),this.type="ShadedReliefShader"}_process(e){const t=super._process(e),{minValue:s,maxValue:a}=this.hillshadeConfig,r=this._getPixel(e),o=a.subtract(s),n=r.r.subtract(s),l=N(n.divide(o),new d(0),new d(1)),c=Fe(new w(l,l,l,1),new d(255),this.colormapConfig),p=Et(c.xyz),h=Wt(new b(p.xy,t.x.divide(255))).multiply(255);return new w(h,c.a.multiply(t.a))}}u([m(se)],ps.prototype,"colormapConfig",void 0);class Cr extends F{constructor(){super(...arguments),this.name="RasterShadedReliefProcessor",this.type=k.ShadedRelief,this.shaders={shadedRelief:new ps}}_process(e,t,s){const a=e.rasterFunction.parameters,r={isMultidirectional:a.hillshadeType>0},o=t.getRasterCellSize(),n=Zt(a,o),l={...a,factor:n},c={colormapTexture:{texture:s,unit:1},colormapOffset:a.offset,colormapMaxIndex:a.indexedColormap.length/4-1},p=this._getCommonConfig(e,t),h={shader:this.shaders.shadedRelief,uniforms:{config:p,hillshadeConfig:l,colormapConfig:c},defines:r,optionalAttributes:null,useComputeBuffer:!1},{painter:f,context:g}=e;f.submitDrawMesh(g,h,f.quadMesh)}}let Pe=class extends z{};u([m(d)],Pe.prototype,"pixelSizePower",void 0),u([m(d)],Pe.prototype,"pixelSizeFactor",void 0),u([m(d)],Pe.prototype,"zFactor",void 0),u([m(_)],Pe.prototype,"cellSize",void 0);class Le extends ${constructor(){super(...arguments),this.type="SlopeShader",this.isOutputRounded=!1,this.percentRise=!1}_process(e){const{cellSize:t,pixelSizePower:s,pixelSizeFactor:a,zFactor:r}=this.slopeConfig,o=J(t,new _(s)).multiply(a).add(r).divide(t.multiply(8)),{texture:n}=this.config,l=Ve(n,e,this.config.srcImageSize),{x:c,y:p}=ft(l,o),h=te(c.multiply(c).add(p.multiply(p))),f=this.percentRise?h.multiply(100):Ne(h).multiply(57.2957795),g=new w(f,f,f,l[9]);return this.isOutputRounded?ve(g):g}}u([v],Le.prototype,"isOutputRounded",void 0),u([v],Le.prototype,"percentRise",void 0),u([m(Pe)],Le.prototype,"slopeConfig",void 0);let Tr=class extends F{constructor(){super(...arguments),this.name="RasterSlopeProcessor",this.type=k.Slope,this.shaders={slope:new Le}}_process(e,t){const s=e.rasterFunction.parameters,a={isOutputRounded:s.isOutputRounded,percentRise:s.slopeType==="percent-rise"},r={cellSize:t.getRasterCellSize(),pixelSizePower:s.slopeType==="adjusted"?s.pixelSizePower:0,pixelSizeFactor:s.slopeType==="adjusted"?s.pixelSizeFactor:0,zFactor:s.zFactor},o=this._getCommonConfig(e,t),n={shader:this.shaders.slope,uniforms:{config:o,slopeConfig:r},defines:a,optionalAttributes:null,useComputeBuffer:!1},{painter:l,context:c}=e;l.submitDrawMesh(c,n,l.quadMesh)}};class Ie extends ${constructor(){super(...arguments),this.type="StretchShader",this.isMultiband=!0,this.isOutputRounded=!1,this.useGamma=!1}_process(e){const t=this._getPixel(e);let s=Ht(t,this.stretchConfig,this.useGamma,1);return this.isMultiband||(s=new w(s.rrr,s.a)),this.isOutputRounded?ve(s):s}}u([v],Ie.prototype,"isMultiband",void 0),u([v],Ie.prototype,"isOutputRounded",void 0),u([v],Ie.prototype,"useGamma",void 0),u([m(Q)],Ie.prototype,"stretchConfig",void 0);let Rr=class extends F{constructor(){super(...arguments),this.name="RasterStretchProcessor",this.type=k.Stretch,this.shaders={stretch:new Ie}}_process(e,t){const s=e.rasterFunction.parameters,a={isMultiband:s.bandCount>1,isOutputRounded:s.isOutputRounded,useGamma:s.useGamma},r=this._getCommonConfig(e,t),o={shader:this.shaders.stretch,uniforms:{config:r,stretchConfig:s},defines:a,optionalAttributes:null,useComputeBuffer:!1},{painter:n,context:l}=e;n.submitDrawMesh(l,o,n.quadMesh)}};const Sr=new Map([["Aspect",ir],["BandArithmetic",ar],["ColormapToRGB",or],["CompositeBand",lr],["ComputeChange",ur],["ContrastBrightness",cr],["Convolution",hr],["Curvature",pr],["ExtractBand",dr],["Grayscale",fr],["Hillshade",gr],["Local",yr],["Mask",wr],["NDVI",br],["Remap",xr],["Reproject",vr],["ShadedRelief",Cr],["Slope",Tr],["Statistics",mr],["Stretch",Rr]]);class Pr extends dt{constructor(){super(...arguments),this.type=k.RasterProcessor,this.shaders={},this._techniques=new Map}shutdown(e){var t;super.shutdown(e),(t=this._fbo)==null||t.dispose(),this._fbo=void 0;for(const s of this._techniques.values())s.shutdown();this._techniques.clear()}render(e,t){this._fbo??(this._fbo=Xt(e.context,ce,ce));let{name:s}=e.rasterFunction;if(s==="Arithmetic"&&(s="Local"),!this._techniques.has(s)){const a=Sr.get(s);if(!a)return;this._techniques.set(s,new a)}this._techniques.get(s).render(e,{...t,processorFbo:this._fbo})}}let Ir=class extends $t{constructor(){super(...arguments),this.isCustomTilingScheme=!1}createTile(e){const t=this._getTileBounds(e),[s,a]=this.tileInfoView.tileInfo.size,r=this.tileInfoView.getTileResolution(e.level);return new Ei(e,r,t[0],t[3],s,a)}onAttach(){super.onAttach(),this._colorizerTechnique=new er,this._processorTechnique=new Pr}onDetach(){var e,t;super.onDetach(),(e=this._colorizerTechnique)==null||e.shutdown(),this._colorizerTechnique=void 0,(t=this._processorTechnique)==null||t.shutdown(),this._processorTechnique=void 0}doRender(e){var a;if(!this.visible||e.drawPhase!==et.MAP||!this._colorizerTechnique)return;const{rasterFunctionChain:t}=this;if((a=t==null?void 0:t.functions)!=null&&a.length){if(!this._processorTechnique)return;const{functions:r,hasBranches:o}=t;for(const n of r){if(n.name==="Constant"||n.name==="Identity")continue;e.rasterFunction=n,e.hasBranches=o,super.doRender(e);const l=this.children.map((c=>c.bitmap));this._processorTechnique.render(e,{bitmaps:l})}}e.rasterFunction=null,super.doRender(e);const s=this.children.map((r=>r.bitmap));this._colorizerTechnique.render(e,{bitmaps:s})}_getTileBounds(e){const t=this.tileInfoView.getTileBounds(Pt(),e);if(this.isCustomTilingScheme&&e.world){const{tileInfo:s}=this.tileInfoView,a=Cs(s.spatialReference);if(a){const r=s.lodAt(e.level);if(!r)return t;const{resolution:o}=r,n=o*s.size[0];t[0]=a*e.world+s.origin.x+e.col*n,t[2]=t[0]+n}}return t}};const zr=[0,0];let B=class extends Ts{constructor(){super(...arguments),this._updatingHandles=new Rs,this._emptyTilePixelBlock=null,this._tileStrategy=null,this._tileInfoView=null,this._fetchQueue=null,this._blockCacheRegistryUrl=null,this._blockCacheRegistryId=null,this._srcResolutions=[],this.previousLOD=null,this._needBlockCacheUpdate=!1,this._globalSymbolizerParams=null,this._symbolizerParams=null,this._abortController=null,this._isCustomTilingScheme=!1,this._maxIndexedColormapSize=0,this._rasterFunctionState="na",this._globalUpdateRequested=!1,this.attached=!1,this.timeExtent=null,this.redrawOrRefetch=Ss((async(i={})=>{const e=this._rasterFunctionState,t=i.reprocess||e==="gpu"&&!this.canUseWebGLForProcessing||e==="cpu"&&this.canUseWebGLForProcessing;if(t&&(await this._updatingHandles.addPromise(this.layer.updateRasterFunction()),this.updateRasterFunctionParameters()),!this.previousLOD||this.layerView.suspended)return;const s=this._rasterFunctionState,{type:a}=this;return i.refetch||a!=="raster"&&t||s==="cpu"||e==="cpu"?this._updatingHandles.addPromise(this.doRefresh()):this._updatingHandles.addPromise(this._redrawImage(i.signal))}))}destroy(){this._updatingHandles.destroy()}get canUseWebGLForProcessing(){return!1}get canUseLocalSymbolizerParams(){return(this.canUseWebGLForProcessing||this.type==="rasterVF")&&!this.layerView.hasTilingEffects}get useWebGLForProcessing(){return this._get("useWebGLForProcessing")??!0}set useWebGLForProcessing(i){this._set("useWebGLForProcessing",i)}get useProgressiveUpdate(){return this._get("useProgressiveUpdate")??!0}set useProgressiveUpdate(i){if(this._tileStrategy&&this.useProgressiveUpdate!==i){this._tileStrategy.destroy(),this.container.removeAllChildren();const e=this._getCacheSize(i);this._tileStrategy=new bt({cachePolicy:"purge",acquireTile:t=>this.acquireTile(t),releaseTile:t=>this.releaseTile(t),cacheSize:e,tileInfoView:this._tileInfoView}),this._set("useProgressiveUpdate",i),this.layerView.requestUpdate()}}update(i){var r;this._fetchQueue.pause(),this._fetchQueue.state=i.state,this._tileStrategy.update(i),this._fetchQueue.resume();const{extent:e,resolution:t,scale:s}=i.state,a=this._tileInfoView.getClosestInfoForScale(s);if(this.layer.raster){if(!this.useProgressiveUpdate||this._needBlockCacheUpdate){const o=this._srcResolutions[a.level],n="toJSON"in e?e:Ps.fromJSON(e);Ct(this._blockCacheRegistryUrl,this._blockCacheRegistryId,n,t,o,this.layer.raster.ioConfig.sampling)}this._needBlockCacheUpdate=!1,((r=this.previousLOD)==null?void 0:r.level)!==a.level&&(this.previousLOD=a,this._symbolizerParams!=null&&this.canUseLocalSymbolizerParams&&this._updateSymbolizerParams(),this._tileStrategy.updateCacheSize(0))}}moveEnd(){!this.layerView.hasTilingEffects&&this.useProgressiveUpdate||(this._abortController&&this._abortController.abort(),this._abortController=new AbortController,this._fetchQueue.length===0&&this._redrawImage(this._abortController.signal).then((()=>{this._globalUpdateRequested=!1,this.layerView.requestUpdate()})));const i=this._getCacheSize(this.useProgressiveUpdate);this._tileStrategy.updateCacheSize(i),this.layerView.requestUpdate()}get updating(){var i;return this._globalUpdateRequested||((i=this._updatingHandles)==null?void 0:i.updating)}attach(){const i=Is();this._maxIndexedColormapSize=4*(i.maxTextureSize||4096),this._initializeTileInfo(),this._tileInfoView=new zs(this.layerView.tileInfo,this.layerView.fullExtent);const e=this._computeFetchConcurrency();this._fetchQueue=new ks({tileInfoView:this._tileInfoView,concurrency:e,process:(s,a)=>this._fetchTile(s,a),priority:$s.MAPVIEW_FETCH_QUEUE,scheduler:this.scheduler});const t=this._getCacheSize(this.useProgressiveUpdate);this._tileStrategy=new bt({cachePolicy:"purge",acquireTile:s=>this.acquireTile(s),releaseTile:s=>this.releaseTile(s),cacheSize:t,tileInfoView:this._tileInfoView}),this._updateBlockCacheRegistry()}detach(){this._tileStrategy.destroy(),this._fetchQueue.clear(),this.container.removeAllChildren(),this._fetchQueue=this._tileStrategy=this._tileInfoView=null,Tt(this._blockCacheRegistryUrl,this._blockCacheRegistryId),this._blockCacheRegistryUrl=this._blockCacheRegistryId=null}acquireTile(i){const e=this.container.createTile(i);return this._updatingHandles.addPromise(this._enqueueTileFetch(e)),this.layerView.requestUpdate(),this._needBlockCacheUpdate=!0,this._globalUpdateRequested=this.layerView.hasTilingEffects||!this.useProgressiveUpdate,e}releaseTile(i){this._fetchQueue.abort(i.key.id),this.container.removeChild(i),i.once("detach",(()=>{i.destroy(),this.layerView.requestUpdate()})),this.layerView.requestUpdate()}createEmptyTilePixelBlock(i=null){const e=i==null||i.join(",")===this._tileInfoView.tileInfo.size.join(",");if(e&&this._emptyTilePixelBlock!=null)return this._emptyTilePixelBlock;i=i||this._tileInfoView.tileInfo.size;const[t,s]=i,a=new $i({width:t,height:s,pixels:[new Uint8Array(t*s)],mask:new Uint8Array(t*s),pixelType:"u8"});return e&&(this._emptyTilePixelBlock=a),a}_getBandIds(){if(!("rasterFunctionChain"in this.container)||!this.container.rasterFunctionChain)return this.layer.bandIds;const{bandIds:i,raster:e}=this.layer,t="rasterFunction"in e?e.rasterFunction.rawInputBandIds:null;return i!=null&&i.length&&(t!=null&&t.length)&&e.rasterInfo.bandCount!==1?i.map((s=>t[Math.min(s,t.length-1)])):"rasterFunction"in e?t:i}updateRasterFunctionParameters(){}_fetchTile(i,e){const t=this._getFetchOptions(i.level,e.signal);return this.fetchTile(i,t)}_getFetchOptions(i,e){var c;const{canUseWebGLForProcessing:t}=this,{layerView:s}=this,{tileInfo:a}=s,r=!a.isWrappable&&Bi(s.view.spatialReference)!=null,o=t&&this.layer.raster.hasUniqueSourceStorageInfo,{layer:n}=this.layerView,l=(c=n.serviceRasterInfo)!=null&&c.storageInfo.isBsqTile?n.bandIds:void 0;return{allowPartialFill:!0,datumTransformation:s.datumTransformation,interpolation:t?"nearest":this.layer.interpolation,registryId:this._blockCacheRegistryId,requestRawData:o,skipRasterFunction:this.type==="raster"&&this.container.rasterFunctionChain!=null,signal:e,srcResolution:this._srcResolutions[i],timeExtent:s.timeExtent,tileInfo:a,bandIds:l,disableWrapAround:r}}_getCacheSize(i){return i?40:0}_initializeTileInfo(){const{layerView:i}=this,e=i.view.spatialReference;if(this._canUseLayerLODs()){const{origin:c,lods:p}=this.layer.tileInfo,h=p.map((({scale:g})=>g)),f=xt.create({spatialReference:e,size:ce,scales:h,origin:c});return i.set("tileInfo",f),void(this._srcResolutions=p.map((({resolution:g})=>({x:g,y:g}))))}const{scales:t,srcResolutions:s,isCustomTilingScheme:a}=Oi(this.layer.serviceRasterInfo,e,{tileSize:ce,alignGlobalDatasetWithAGOL:!0}),r=xt.create({spatialReference:e,size:ce,scales:t}),o=r.origin.x===0;Ms(i.fullExtent);const{xmin:n,ymax:l}=i.fullExtent;(o||a&&r.origin.x>n)&&(r.origin=new Fs({x:n,y:l,spatialReference:e})),this._isCustomTilingScheme=a,i.set("tileInfo",r),this._srcResolutions=s??[]}_canUseLayerLODs(){var a;const{layer:i,layerView:e}=this;if(i.raster.tileType!=="Map")return!1;const{lods:t}=i.tileInfo,s=(a=e.view.constraints)==null?void 0:a.effectiveLODs;return(s==null?void 0:s.length)===t.length&&s.every((({scale:r},o)=>Math.abs(r-t[o].scale)<.001))}_computeFetchConcurrency(){const{blockBoundary:i}=this.layer.serviceRasterInfo.storageInfo,e=i[i.length-1];return(e.maxCol-e.minCol+1)*(e.maxRow-e.minRow+1)>64?2:10}async _enqueueTileFetch(i,e){var t;if(!this._fetchQueue.has(i.key.id)){try{const s=await this._fetchQueue.push(i.key),a=this._getBandIds();let r=!this.useProgressiveUpdate||this.layerView.hasTilingEffects&&!this._globalSymbolizerParams;if(this._globalUpdateRequested&&!this.layerView.moving&&this._fetchQueue.length===0){r=!1;try{await this._redrawImage((t=this._abortController)==null?void 0:t.signal)}catch(l){ze(l)&&ke.getLogger(this).error(l)}this._globalUpdateRequested=!1}this.canUseLocalSymbolizerParams&&this._symbolizerParams==null&&this._updateSymbolizerParams();const o=this._tileInfoView.getTileCoords(zr,i.key),n=this._tileInfoView.getTileResolution(i.key);await this.updateTileSource(i,{source:s,symbolizerParams:this._symbolizerParams,globalSymbolizerParams:this._globalSymbolizerParams,suspended:r,bandIds:a,coords:o,resolution:n}),i.once("attach",(()=>this.layerView.requestUpdate())),this.container.addChild(i)}catch(s){ze(s)||ke.getLogger(this).error(s)}this.layerView.requestUpdate()}}async _redrawImage(i){if(this.container.children.length===0)return;await this.layer.updateRenderer(),this.layerView.hasTilingEffects?await this._updateGlobalSymbolizerParams(i):(this.canUseLocalSymbolizerParams&&this._updateSymbolizerParams(),this._globalSymbolizerParams=null);const e=this.container.children.map((async t=>this.updateTileSymbolizerParameters(t,{local:this._symbolizerParams,global:this._globalSymbolizerParams})));await Promise.allSettled(e),this.container.requestRender()}async _updateGlobalSymbolizerParams(i){const e=this._getFetchOptions(this.previousLOD.level,i),t=await this.layer.fetchPixels(this.layerView.view.extent,this.layerView.view.width,this.layerView.view.height,{...e,interpolation:"nearest",requestRawData:!1,skipRasterFunction:!1});if(!(t!=null&&t.pixelBlock))return;const{resolution:s}=this.previousLOD,{isBsqTile:a}=this.layer.raster.rasterInfo.storageInfo,r=a?null:this._getBandIds(),o=this.layer.symbolizer.generateWebGLParameters({pixelBlock:t.pixelBlock.extractBands(r),isGCS:this.layerView.view.spatialReference.isGeographic,resolution:{x:s,y:s},bandIds:r});!this.canUseWebGLForProcessing&&o&&o.type==="stretch"&&this.layer.renderer&&this.layer.renderer.type==="raster-stretch"&&(o.factor=o.factor.map((n=>255*n)),o.minOutput=Math.round(255*o.minOutput),o.maxOutput=Math.round(255*o.maxOutput)),this._globalSymbolizerParams=o}_updateSymbolizerParams(){const{resolution:i}=this.previousLOD,e=this._getBandIds();this._symbolizerParams=this.layer.symbolizer.generateWebGLParameters({pixelBlock:null,isGCS:this.layerView.view.spatialReference.isGeographic,resolution:{x:i,y:i},bandIds:e})}_updateBlockCacheRegistry(i=!1){var l;const{layer:e,layerView:t}=this,{raster:s}=e,{multidimensionalDefinition:a}=e.normalizeRasterFetchOptions({multidimensionalDefinition:e.multidimensionalDefinition,timeExtent:t.timeExtent}),r=s.rasterInfo.multidimensionalInfo?s.getSliceIndex(a):null,o=s.rasterInfo.storageInfo.isBsqTile&&((l=e.bandIds)!=null&&l.length)?e.bandIds:null,n=Fi(s.rasterId,r,o);if(n!==this._blockCacheRegistryUrl){if(this._blockCacheRegistryUrl!=null&&Tt(this._blockCacheRegistryUrl,this._blockCacheRegistryId),this._blockCacheRegistryId=Vi(n,s.rasterInfo),i){const{view:c}=t,p=this._tileInfoView.getClosestInfoForScale(c.scale),h=this._srcResolutions[p.level];Ct(n,this._blockCacheRegistryId,c.extent,c.resolution,h,s.ioConfig.sampling)}this._blockCacheRegistryUrl=n}}async doRefresh(){if(!this.attached||!this.previousLOD||this.layerView.suspended)return;await this.layer.updateRenderer(),this.canUseLocalSymbolizerParams&&this._updateSymbolizerParams(),this._updateBlockCacheRegistry(!0),this._fetchQueue.reset();const i=[];this._globalUpdateRequested=this.layerView.hasTilingEffects||!this.useProgressiveUpdate,this._tileStrategy.refresh((e=>i.push(this._enqueueTileFetch(e)))),await this._updatingHandles.addPromise(Promise.allSettled(i))}};u([C()],B.prototype,"_globalUpdateRequested",void 0),u([C()],B.prototype,"attached",void 0),u([C()],B.prototype,"canUseWebGLForProcessing",null),u([C()],B.prototype,"canUseLocalSymbolizerParams",null),u([C()],B.prototype,"container",void 0),u([C()],B.prototype,"layer",void 0),u([C()],B.prototype,"layerView",void 0),u([C()],B.prototype,"scheduler",void 0),u([C()],B.prototype,"type",void 0),u([C()],B.prototype,"useWebGLForProcessing",null),u([C()],B.prototype,"useProgressiveUpdate",null),u([C()],B.prototype,"timeExtent",void 0),u([C()],B.prototype,"updating",null),B=u([Me("esri.views.2d.layers.imagery.BaseImageryTileSubView2D")],B);let le=class extends B{constructor(){super(...arguments),this.type="raster"}get canUseWebGLForProcessing(){var r;const{loaded:i,symbolizer:e}=this.layer;if(!i||!e)return!1;const t=(r=e.lookup.colormapLut)==null?void 0:r.indexedColormap,s=t&&t.length>this._maxIndexedColormapSize,a=Vs(this.layer.serviceRasterInfo);return!(Bs("ios")&&a>4)&&this.useWebGLForProcessing&&e.canRenderInWebGL&&!s&&!(this.layer.interpolation==="majority"&&It(this.layer))}attach(){super.attach(),this.container=new Ir(this._tileInfoView),this.container.isCustomTilingScheme=this._isCustomTilingScheme,this.updateRasterFunctionParameters()}detach(){super.detach(),this.container.removeAllChildren(),this.container=null}fetchTile(i,e){return this.layer.fetchTile(i.level,i.row,i.col,e)}updateRasterFunctionParameters(){var f;const{raster:i,type:e}=this.layer,{container:t}=this;if(i.datasetFormat!=="Function"||e==="wcs")return t.rasterFunctionChain=null,t.children.forEach((g=>{const{bitmap:y}=g;y&&(y.suspended=!0,y.processed=!1,y.projected&&(y.invalidateTexture(),y.rasterTexture=null))})),void(this._rasterFunctionState="na");const s=this._rasterFunctionState,{rasterFunction:a,primaryRasters:r}=i,o=a.supportsGPU&&(!r||r.rasters.length<=1),n=o?a.flatWebGLFunctionChain:null,{renderer:l}=this.layer,c=!o||!(n!=null&&n.functions.length)||(l==null?void 0:l.type)==="raster-stretch"&&l.dynamicRangeAdjustment||!this.canUseWebGLForProcessing;t.rasterFunctionChain=c?null:this._addProjection(n);const p=a==null?"na":t.rasterFunctionChain?"gpu":"cpu",h=s===p||s==="na"&&p==="cpu"&&((f=n==null?void 0:n.functions)==null?void 0:f.length)===0;t.children.forEach((g=>{const{bitmap:y}=g;y&&(y.suspended=!h,y.processed=!1,y.processedTexture=null)})),this._rasterFunctionState=p}async updateTileSource(i,e){const t=this._getBandIds(),s=this._getLayerInterpolation(),{canUseWebGLForProcessing:a}=this,{source:r,globalSymbolizerParams:o,suspended:n,coords:l,resolution:c}=e,p=this.layerView.hasTilingEffects?o:e.symbolizerParams,{bitmap:h}=i;if([h.x,h.y]=l,h.resolution=c,(r==null?void 0:r.pixelBlock)!=null){const y={extent:r.extent,pixelBlock:r.pixelBlock,srcPixelSize:r.srcTilePixelSize};if(h.rawPixelData=y,a)h.source=r.pixelBlock,h.isRendereredSource=!1;else{const x=await this.layer.applyRenderer(y,(o==null?void 0:o.type)==="stretch"?o:void 0);h.source=x,h.isRendereredSource=!0}h.symbolizerParameters=a?p:null,h.transformGrid=a?r.transformGrid:null}else{const y=this.createEmptyTilePixelBlock();h.source=y,h.symbolizerParameters=a?p:null,h.transformGrid=null}const{isBsqTile:f}=this.layer.raster.rasterInfo.storageInfo;h.bandIds=a&&!f?t:null,h.width=this._tileInfoView.tileInfo.size[0],h.height=this._tileInfoView.tileInfo.size[1],h.interpolation=s,h.suspended=n;const{raster:g}=this.layer;if(zt(g)){const y=g.getClippingGeometry(this.layerView.view.spatialReference);if(y){const x=g.getTileExtentFromTileInfo(i.key.level,i.key.row,i.key.col,this._tileInfoView.tileInfo);h.mask=Hs({srcExtent:x,geometry:y,size:[h.width,h.height]})}}h.invalidateTexture()}async updateTileSymbolizerParameters(i,e){const{local:t,global:s}=e,a=this._getBandIds(),r=this._getLayerInterpolation(),{canUseWebGLForProcessing:o}=this,{bitmap:n}=i,{rawPixelData:l}=n;o||l==null?(n.isRendereredSource&&l!=null&&(n.source=l.pixelBlock),n.isRendereredSource=!1):(n.source=await this.layer.applyRenderer(l,(s==null?void 0:s.type)==="stretch"?s:void 0),n.isRendereredSource=!0),n.symbolizerParameters=o?this.layerView.hasTilingEffects?s:t:null;const{isBsqTile:c}=this.layer.raster.rasterInfo.storageInfo;n.bandIds=o&&!c?a:null,n.interpolation=r,n.suspended=!1}_getLayerInterpolation(){const{interpolation:i,renderer:e}=this.layer;if(!e)return i;const t=e.type;return t==="raster-colormap"||t==="unique-value"?"nearest":e.type==="raster-stretch"&&e.colorRamp!=null?i==="bilinear"||i==="cubic"?"bilinear":"nearest":i}_addProjection(i){var e;return(e=i==null?void 0:i.functions)!=null&&e.length&&!i.hasFocalFunction&&i.functions.unshift({name:"Reproject",parameters:{targetImageSize:this._tileInfoView.tileInfo.size,requireNNEdge:i.isSourceSingleBand},pixelType:"f32",id:0,isNoopProcess:!1}),i}};u([C()],le.prototype,"canUseWebGLForProcessing",null),u([C()],le.prototype,"container",void 0),u([C()],le.prototype,"layer",void 0),u([C()],le.prototype,"type",void 0),le=u([Me("esri.views.2d.layers.imagery.ImageryTileView2D")],le);class kr extends kt{constructor(e,t,s,a,r,o,n=null){super(e,t,s,a,r,o),this.tileData=new Ls(n),this.tileData.coordScale=[r,o],this.tileData.once("isReady",(()=>this.ready()))}destroy(){super.destroy(),this.tileData.destroy(),this.tileData=null,this.stage=null}set stencilRef(e){this.tileData.stencilRef=e}get stencilRef(){return this.tileData.stencilRef}_createTransforms(){return{displayViewScreenMat3:$e(),tileMat3:$e()}}setTransform(e){super.setTransform(e);const t=this.resolution/(e.resolution*e.pixelRatio),s=this.transforms.tileMat3,[a,r]=this.tileData.offset,o=[this.x+a*this.resolution,this.y-r*this.resolution],[n,l]=e.toScreenNoRotation([0,0],o),{symbolTileSize:c}=this.tileData.symbolizerParameters,p=Math.round((this.width-this.tileData.offset[0])/c)*c,h=Math.round((this.height-this.tileData.offset[1])/c)*c,f=p/this.rangeX*t,g=h/this.rangeY*t;Os(s,f,0,0,0,g,0,n,l,1),St(this.transforms.displayViewScreenMat3,e.displayViewMat3,s),this.tileData.transforms.displayViewScreenMat3=this.transforms.displayViewScreenMat3}onAttach(){this.tileData.stage=this.stage}onDetach(){this.tileData.stage=null}}class $r extends $t{constructor(){super(...arguments),this.isCustomTilingScheme=!1,this.symbolTypes=["triangle"]}createTile(e){const t=this.tileInfoView.getTileBounds(Pt(),e),[s,a]=this.tileInfoView.tileInfo.size,r=this.tileInfoView.getTileResolution(e.level);return new kr(e,r,t[0],t[3],s,a)}prepareRenderPasses(e){const t=e.registerRenderPass({name:"imagery (vf tile)",brushes:[Es],target:()=>this.children.map((s=>s.tileData)),drawPhase:et.MAP});return[...super.prepareRenderPasses(e),t]}doRender(e){this.visible&&e.drawPhase===et.MAP&&this.symbolTypes.forEach((t=>{e.renderPass=t,super.doRender(e)}))}}let ge=class extends B{constructor(){super(...arguments),this._handle=null,this.type="rasterVF"}async fetchTile(i,e){var s;e={...e,interpolation:"nearest",requestProjectedLocalDirections:!0};const t=await this.layer.fetchTile(i.level,i.row,i.col,e);return((s=this.layer.serviceRasterInfo)==null?void 0:s.dataType)==="vector-magdir"&&(t!=null&&t.pixelBlock)&&(t.pixelBlock=await this.layer.convertVectorFieldData(t.pixelBlock,"vector-magdir",e)),t}updateTileSource(i,e){const t=e.symbolizerParams,{tileData:s}=i;s.key=i.key,s.width=this._tileInfoView.tileInfo.size[0],s.height=this._tileInfoView.tileInfo.size[1];const{symbolTileSize:a}=t,{source:r}=e;if(s.offset=this._getTileSymbolOffset(s.key,a),(r==null?void 0:r.pixelBlock)!=null){const o={extent:r.extent,pixelBlock:r.pixelBlock};s.rawPixelData=o,s.symbolizerParameters=t,s.source=this._sampleVectorFieldData(r.pixelBlock,t,s.offset)}else{const o=[Math.round((this._tileInfoView.tileInfo.size[0]-s.offset[0])/a),Math.round((this._tileInfoView.tileInfo.size[1]-s.offset[1])/a)],n=this.createEmptyTilePixelBlock(o);s.source=n,s.symbolizerParameters=t}return s.invalidateVAO(),Promise.resolve()}updateTileSymbolizerParameters(i,e){var n;const t=e.local,{symbolTileSize:s}=t,{tileData:a}=i;a.offset=this._getTileSymbolOffset(a.key,s);const r=a.symbolizerParameters.symbolTileSize;a.symbolizerParameters=t;const o=(n=a.rawPixelData)==null?void 0:n.pixelBlock;return o!=null&&r!==s&&(a.source=this._sampleVectorFieldData(o,a.symbolizerParameters,a.offset)),Promise.resolve()}attach(){super.attach(),this.container=new $r(this._tileInfoView),this.container.isCustomTilingScheme=this._isCustomTilingScheme,this._updateSymbolType(this.layer.renderer),this._handle=Ae((()=>this.layer.renderer),(i=>this._updateSymbolType(i)))}detach(){var i;super.detach(),this.container.removeAllChildren(),(i=this._handle)==null||i.remove(),this._handle=null,this.container=null}_getTileSymbolOffset(i,e){const t=i.col*this._tileInfoView.tileInfo.size[0]%e,s=i.row*this._tileInfoView.tileInfo.size[1]%e;return[t>e/2?e-t:-t,s>e/2?e-s:-s]}_sampleVectorFieldData(i,e,t){const{symbolTileSize:s}=e;return Mi(i,"vector-uv",s,t)}_updateSymbolType(i){(i==null?void 0:i.type)==="vector-field"&&(this.container.symbolTypes=i.style==="wind-barb"?["scalar","triangle"]:i.style==="simple-scalar"?["scalar"]:["triangle"])}};u([C()],ge.prototype,"container",void 0),u([C()],ge.prototype,"layer",void 0),u([C()],ge.prototype,"type",void 0),ge=u([Me("esri.views.2d.layers.imagery.VectorFieldTileView2D")],ge);const Mr=i=>{let e=class extends i{constructor(){super(...arguments),this.layer=null,this.tileInfo=null}get fullExtent(){try{return this.layer.loaded?this._getFullExtent():null}catch{return null}}get timeExtent(){var t;return Gi(this.layer,(t=this.view)==null?void 0:t.timeExtent,this._get("timeExtent"))}get hasTilingEffects(){return!!(this.layer.renderer&&"dynamicRangeAdjustment"in this.layer.renderer&&this.layer.renderer.dynamicRangeAdjustment)}get datumTransformation(){try{return this.layer.loaded?Di(this.layer.fullExtent,this.view.spatialReference,!0):null}catch{return null}}supportsSpatialReference(t){try{return!this.layer.loaded||!!Rt(this.layer.serviceRasterInfo,t)}catch{return!1}}async fetchPopupFeaturesAtLocation(t,s){var f,g;const{layer:a}=this;if(!t)throw new Ds("imageryTileLayerView:fetchPopupFeatures","Nothing to fetch without area",{layer:a});const{popupEnabled:r}=a,o=Ui(a,s);if(!r||o==null)return[];const n=[],{value:l,magdirValue:c,processedValue:p}=await a.identify(t,{timeExtent:this.timeExtent,signal:s==null?void 0:s.signal});let h="";if(l!=null&&l.length){h=a.type==="imagery-tile"&&a.hasStandardTime()&&l[0]!=null?l.map((Z=>a.getStandardTimeValue(Z))).join(", "):l.join(", ");const y={ObjectId:0};y[Ce.servicePixelValue]=a.type==="imagery-tile"&&zt(a.raster)?p==null?void 0:p.join(", "):h,y[Ce.rawServicePixelValue]=h;const x=((f=a.raster)==null?void 0:f.rasterInfo)??a.serviceRasterInfo,T=x==null?void 0:x.attributeTable;if(T!=null){const{fields:Z,features:He}=T,wt=Z.find((({name:re})=>re.toLowerCase()==="value")),ds=y[Ce.servicePixelValue],Be=wt?He.find((re=>String(re.attributes[wt.name])===ds)):null;if(Be)for(const re in Be.attributes)Be.attributes.hasOwnProperty(re)&&(y[js+re]=Be.attributes[re])}const P=x==null?void 0:x.dataType;P!=="vector-magdir"&&P!=="vector-uv"||(y[Ce.magnitude]=c==null?void 0:c[0],y[Ce.direction]=c==null?void 0:c[1]);const{multidimensionalDefinition:R}=this.layer.normalizeRasterFetchOptions({timeExtent:this.timeExtent});qs(a.rasterFields,y,R);const q=new As({geometry:(g=this.fullExtent)==null?void 0:g.clone(),attributes:y,layer:a,sourceLayer:a});n.push(q)}return n}async getSourceScale(){return await this.layer.load(),Ai(this.layer.serviceRasterInfo,this.view.spatialReference)}_getFullExtent(){return Rt(this.layer.serviceRasterInfo,this.view.spatialReference)}};return u([C()],e.prototype,"fullExtent",null),u([C()],e.prototype,"layer",void 0),u([C({readOnly:!0})],e.prototype,"timeExtent",null),u([C()],e.prototype,"tileInfo",void 0),u([C({readOnly:!0})],e.prototype,"hasTilingEffects",null),u([C()],e.prototype,"datumTransformation",null),e=u([Me("esri.views.layers.ImageryTileLayerView")],e),e};let ue=class extends Mr(qi(Ns(Zs))){constructor(){super(...arguments),this._useWebGLForProcessing=!0,this._useProgressiveUpdate=!0,this.subview=null}get useWebGLForProcessing(){return this._useWebGLForProcessing}set useWebGLForProcessing(i){this._useWebGLForProcessing=i,this.subview&&"useWebGLForProcessing"in this.subview&&(this.subview.useWebGLForProcessing=i)}get useProgressiveUpdate(){return this._useWebGLForProcessing}set useProgressiveUpdate(i){this._useProgressiveUpdate=i,this.subview&&"useProgressiveUpdate"in this.subview&&(this.subview.useProgressiveUpdate=i)}get displayParameters(){const{layer:i}=this,e=this._get("displayParameters");return i.renderer&&i.visible?{bandIds:i.bandIds,renderer:i.renderer,interpolation:i.interpolation,multidimensionalDefinition:i.multidimensionalDefinition,rasterFunction:i.type==="imagery-tile"?i.rasterFunction:null}:e}update(i){var e;(e=this.subview)==null||e.update(i),this.notifyChange("updating")}isUpdating(){return!this.subview||this.subview.updating}attach(){this.layer.increaseRasterJobHandlerUsage(),this._updateSubview(),this.addAttachHandles([Ae((()=>this.displayParameters),((i,e)=>{var c,p,h,f;const t=i.interpolation!==(e==null?void 0:e.interpolation)&&(i.interpolation==="majority"||(e==null?void 0:e.interpolation)==="majority")&&It(this.layer),s=!!((p=(c=this.layer.serviceRasterInfo)==null?void 0:c.storageInfo)!=null&&p.isBsqTile)&&((h=i.bandIds)==null?void 0:h.join())!==((f=e==null?void 0:e.bandIds)==null?void 0:f.join()),a=i.renderer!==(e==null?void 0:e.renderer)&&this._getSubviewType(e==null?void 0:e.renderer)!==this._getSubviewType(i.renderer);a&&this._updateSubview();const r=i.multidimensionalDefinition!==(e==null?void 0:e.multidimensionalDefinition),o=i.rasterFunction!==(e==null?void 0:e.rasterFunction),n=o&&!this._useWebGLForProcessing,l=r||t||a||n||s;this.subview.redrawOrRefetch({refetch:l,reprocess:o}).catch((g=>{ze(g)||ke.getLogger(this).error(g)})),this.notifyChange("updating")})),Ae((()=>this.layer.multidimensionalSubset??null),((i,e)=>{const{multidimensionalDefinition:t}=this.layer;t!=null&&_t(t,i)!==_t(t,e)&&(this.subview.redrawOrRefetch({refetch:!0}).catch((s=>{ze(s)||ke.getLogger(this).error(s)})),this.notifyChange("updating"))}),Gs),Ae((()=>this.timeExtent),(()=>{this.subview.timeExtent=this.timeExtent,this.subview.redrawOrRefetch({refetch:!0}).catch((i=>{ze(i)||ke.getLogger(this).error(i)}))}),Us)])}detach(){var i;this.layer.decreaseRasterJobHandlerUsage(),this._detachSubview(this.subview),(i=this.subview)==null||i.destroy(),this.subview=null}viewChange(){this.requestUpdate()}moveEnd(){this.subview.moveEnd()}doRefresh(){return this.subview?this.subview.doRefresh():Promise.resolve()}_updateSubview(){var a;const{renderer:i}=this.layer;if(!i)return;const e=this._getSubviewType(i);if(this.subview){if(this.subview.type===e)return void this._attachSubview(this.subview);this._detachSubview(this.subview),(a=this.subview)==null||a.destroy(),this.subview=null}const{layer:t}=this;let s;if(s=e==="rasterVF"?new ge({layer:t,layerView:this,scheduler:this.scheduler}):e==="flow"?new Ws({layer:t,layerView:this,scheduler:this.scheduler}):new le({layer:t,layerView:this,scheduler:this.scheduler}),"useWebGLForProcessing"in s&&(s.useWebGLForProcessing=this._useWebGLForProcessing),"useProgressiveUpdate"in s&&(s.useProgressiveUpdate=this._useProgressiveUpdate),"previousLOD"in s){const{subview:r}=this;s.previousLOD=r&&"previousLOD"in r?r.previousLOD:null}this._attachSubview(s),this.subview=s,this.requestUpdate()}_attachSubview(i){i&&!i.attached&&(i.attach(),i.attached=!0,this.container.addChildAt(i.container,0))}_detachSubview(i){i!=null&&i.attached&&(this.container.removeChild(i.container),i.detach(),i.attached=!1)}_getSubviewType(i){const e=i==null?void 0:i.type;return e==="vector-field"?"rasterVF":e==="flow"?"flow":"raster"}};u([C()],ue.prototype,"subview",void 0),u([C()],ue.prototype,"useWebGLForProcessing",null),u([C()],ue.prototype,"useProgressiveUpdate",null),u([C({readOnly:!0})],ue.prototype,"displayParameters",null),ue=u([Me("esri.views.2d.layers.ImageryTileLayerView2D")],ue);const go=ue;export{go as default};
