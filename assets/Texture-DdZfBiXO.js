import{aH as $,j1 as R,lz as h,fR as T,ky as b,b4 as F,jQ as U,gA as V,kX as E,lS as B,fP as O,dw as f,jS as c,gF as X,b_ as y,mD as k,dc as G,de as N,dC as z,db as W,mE as j}from"./index-Bkom2Sdc.js";import{r as K}from"./videoUtils-BGblNLFr.js";import{t as q}from"./requestImageUtils-CneTXhgG.js";import{S as Q}from"./OutputColorHighlightOID.glsl-FoayQX8i.js";import{s as Y}from"./BufferView-w_yOhrVp.js";function Z(){return w??=(async()=>{const r=await $(()=>import("./basis_transcoder-DuG70Smz.js"),[]),t=await r.default({locateFile:e=>R(`esri/libs/basisu/${e}`)});return t.initializeBasis(),t})(),w}let w,o=null,g=null;async function A(){return g==null&&(g=Z(),o=await g),g}function J(r,t){if(o==null)return r.byteLength;const e=new o.BasisFile(new Uint8Array(r)),a=C(e)?D(e.getNumLevels(0),e.getHasAlpha(),e.getImageWidth(0,0),e.getImageHeight(0,0),t):0;return e.close(),e.delete(),a}function tt(r,t){if(o==null)return r.byteLength;const e=new o.KTX2File(new Uint8Array(r)),a=I(e)?D(e.getLevels(),e.getHasAlpha(),e.getWidth(),e.getHeight(),t):0;return e.close(),e.delete(),a}function D(r,t,e,a,i){const s=b(t?h.COMPRESSED_RGBA8_ETC2_EAC:h.COMPRESSED_RGB8_ETC2),n=i&&r>1?(4**r-1)/(3*4**(r-1)):1;return Math.ceil(e*a*s*n)}function C(r){return r.getNumImages()>=1&&!r.isUASTC()}function I(r){return r.getFaces()>=1&&r.isETC1S()}async function et(r,t,e){o==null&&(o=await A());const a=new o.BasisFile(new Uint8Array(e));if(!C(a))return null;a.startTranscoding();const i=v(r,t,a.getNumLevels(0),a.getHasAlpha(),a.getImageWidth(0,0),a.getImageHeight(0,0),(s,n)=>a.getImageTranscodedSizeInBytes(0,s,n),(s,n,l)=>a.transcodeImage(l,0,s,n,0,0));return a.close(),a.delete(),i}async function at(r,t,e){o==null&&(o=await A());const a=new o.KTX2File(new Uint8Array(e));if(!I(a))return null;a.startTranscoding();const i=v(r,t,a.getLevels(),a.getHasAlpha(),a.getWidth(),a.getHeight(),(s,n)=>a.getImageTranscodedSizeInBytes(s,0,0,n),(s,n,l)=>a.transcodeImage(l,s,0,0,n,0,-1,-1));return a.close(),a.delete(),i}function v(r,t,e,a,i,s,n,l){const{compressedTextureETC:d,compressedTextureS3TC:x}=r.capabilities,[_,L]=d?a?[1,h.COMPRESSED_RGBA8_ETC2_EAC]:[0,h.COMPRESSED_RGB8_ETC2]:x?a?[3,h.COMPRESSED_RGBA_S3TC_DXT5_EXT]:[2,h.COMPRESSED_RGB_S3TC_DXT1_EXT]:[13,6408],H=t.hasMipmap?e:Math.min(1,e),p=[];for(let u=0;u<H;u++)p.push(new Uint8Array(n(u,_))),l(u,_,p[u]);return t.internalFormat=L,t.hasMipmap=p.length>1,t.samplingMode=t.hasMipmap?9987:9729,t.width=i,t.height=s,new T(r,t,{type:"compressed",levels:p})}const m=16;function M(r,t){return t=Math.floor(t/m)*m,Math.min(Math.round(r/m)*m,t)}function ct(r,t){return t=Math.floor(t/m)*m,Math.min(Math.ceil(r/m)*m,t)}function rt(r,t){const[e,a]=it(r,t);return r.width===e&&r.height===a?r:S(r,e,a)}function it({width:r,height:t},{maxPreferredTexturePixels:e,maxTextureSize:a}){const i=Math.max(r,t),s=r*t;if(i<=a&&s<=e)return[r,t];const n=Math.min(Math.sqrt(e/s),a/i);return[M(Math.round(r*n),a),M(Math.round(t*n),a)]}function S(r,t,e){if(r instanceof ImageData)return S(st(r),t,e);const a=document.createElement("canvas");return a.width=t,a.height=e,a.getContext("2d").drawImage(r,0,0,a.width,a.height),a}function st(r){const t=document.createElement("canvas");t.width=r.width,t.height=r.height;const e=t.getContext("2d");if(e==null)throw new F("texture:context-failed","Failed to create 2d context from HTMLCanvasElement");return e.putImageData(r,0,0),t}class _t{constructor(t,e){this._data=t,this.id=U(),this.events=new V,this._parameters={...ot,...e},this._startPreload(t)}dispose(){this.unload(),this._data=this.update=void 0}_startPreload(t){t instanceof HTMLVideoElement?(this.update=e=>this._update(t,e),this._startPreloadVideoElement(t)):t instanceof HTMLImageElement&&this._startPreloadImageElement(t)}_startPreloadVideoElement(t){if(!(E(t.src)||t.preload==="auto"&&t.crossOrigin)&&(t.preload="auto",t.crossOrigin="anonymous",t.src=t.src,t.paused&&t.autoplay)){const e=[];K(t,a=>e.push(a)).then(()=>{t.play()}).finally(()=>e.forEach(a=>a.remove()))}}_startPreloadImageElement(t){B(t.src)||E(t.src)||t.crossOrigin||(t.crossOrigin="anonymous",t.src=t.src)}_createDescriptor(t){const e=new O;return e.wrapMode=this._parameters.wrap??10497,e.flipped=!this._parameters.noUnpackFlip,e.samplingMode=this._parameters.mipmap?9987:9729,e.hasMipmap=!!this._parameters.mipmap,e.preMultiplyAlpha=!!this._parameters.preMultiplyAlpha,e.maxAnisotropy=this._parameters.maxAnisotropy??(this._parameters.mipmap?t.parameters.maxMaxAnisotropy:1),e.dataType=this._parameters.dataType??e.dataType,e.pixelFormat=this._parameters.pixelFormat??e.pixelFormat,e.internalFormat=this._parameters.internalFormat??e.internalFormat,e}get glTexture(){return this._glTexture??this._emptyTexture}get loaded(){return this._glTexture!=null}get usedMemory(){return this._glTexture?.usedMemory||nt(this._data,this._parameters)}load(t){if(this._loadingPromise)return this._loadingPromise;if(this._glTexture)return this._glTexture;const e=this._data;return e==null?(this._glTexture=new T(t,this._createDescriptor(t),null),this._glTexture):(this._emptyTexture=t.emptyTexture,this._parameters.reloadable||(this._data=void 0),typeof e=="string"?this._loadFromURL(t,e):e instanceof Image?this._loadFromImageElement(t,e):e instanceof HTMLVideoElement?this._loadFromVideoElement(t,e):e instanceof ImageData||e instanceof HTMLCanvasElement?this._loadFromImage(t,e):f(e)&&this._parameters.encoding==="image/vnd-ms.dds"?this._loadFromDDSData(t,e):c(e)&&this._parameters.encoding==="image/vnd-ms.dds"?this._loadFromDDSData(t,new Uint8Array(e)):(c(e)||f(e))&&this._parameters.encoding==="image/ktx2"?this._loadFromKTX2(t,e):(c(e)||f(e))&&this._parameters.encoding==="image/x.basis"?this._loadFromBasis(t,e):c(e)?this._loadFromPixelData(t,new Uint8Array(e)):X(e)?this._loadFromPixelData(t,e):null)}_update(t,e){return this._glTexture==null||t.readyState<HTMLMediaElement.HAVE_CURRENT_DATA||e===t.currentTime?e:(this._glTexture.setData(t),this._glTexture.descriptor.hasMipmap&&this._glTexture.generateMipmap(),this._parameters.updateCallback&&this._parameters.updateCallback(),t.currentTime)}_loadFromDDSData(t,e){return this._glTexture=Q(t,this._createDescriptor(t),e),this._emptyTexture=null,this._glTexture}_loadFromKTX2(t,e){return this._loadAsync(()=>at(t,this._createDescriptor(t),e).then(a=>(this._glTexture=a,a)))}_loadFromBasis(t,e){return this._loadAsync(()=>et(t,this._createDescriptor(t),e).then(a=>(this._glTexture=a,a)))}_loadFromPixelData(t,e){Y(this._parameters.width>0&&this._parameters.height>0);const a=this._createDescriptor(t);return a.pixelFormat!==6407&&a.pixelFormat!==6408||(a.compress=this._parameters.compressionOptions),a.width=this._parameters.width??0,a.height=this._parameters.height??0,this._glTexture=new T(t,a,e),this._glTexture}_loadFromURL(t,e){return this._loadAsync(async a=>{const i=await q(e,{signal:a});return y(a),this._loadFromImage(t,i)})}_loadFromImageElement(t,e){return e.complete?this._loadFromImage(t,e):this._loadAsync(async a=>{const i=await k(e,e.src,!1,a);return y(a),this._loadFromImage(t,i)})}_loadFromVideoElement(t,e){return e.readyState>=HTMLMediaElement.HAVE_CURRENT_DATA?this._loadFromImage(t,e):this._loadFromVideoElementAsync(t,e)}_loadFromVideoElementAsync(t,e){return this._loadAsync(a=>new Promise((i,s)=>{const n=()=>{e.removeEventListener("loadeddata",l),e.removeEventListener("error",d),W(x)},l=()=>{e.readyState>=HTMLMediaElement.HAVE_CURRENT_DATA&&(n(),i(this._loadFromImage(t,e)))},d=_=>{n(),s(_||new F("texture:load-error","Failed to load video"))};e.addEventListener("loadeddata",l),e.addEventListener("error",d);const x=G(a,()=>d(N()))}))}_loadFromImage(t,e){let a=e;a instanceof HTMLVideoElement||(a=rt(a,t.parameters));const i=P(a);this._parameters.width=i.width,this._parameters.height=i.height;const s=this._createDescriptor(t);return s.width=i.width,s.height=i.height,s.compress=this._parameters.compressionOptions,this._glTexture=new T(t,s,a),this._emptyTexture=null,this.events.emit("loaded"),this._glTexture}_loadAsync(t){const e=new AbortController;this._loadingController=e;const a=t(e.signal);this._loadingPromise=a;const i=()=>{this._loadingController===e&&(this._loadingController=null),this._loadingPromise===a&&(this._loadingPromise=null),this._emptyTexture=null};return a.then(i,i),a}unload(){if(this._glTexture=z(this._glTexture),this._emptyTexture=null,this._loadingController!=null){const t=this._loadingController;this._loadingController=null,this._loadingPromise=null,t.abort()}this.events.emit("unloaded")}get parameters(){return this._parameters}}function nt(r,t){if(r==null)return 0;if(c(r)||f(r))return t.encoding==="image/ktx2"?tt(r,!!t.mipmap):t.encoding==="image/x.basis"?J(r,!!t.mipmap):r.byteLength;const{width:e,height:a}=r instanceof Image||r instanceof ImageData||r instanceof HTMLCanvasElement||r instanceof HTMLVideoElement?P(r):t,i=t.pixelFormat??6408,s=j(i);return(t.mipmap?4/3:1)*e*a*s||0}function P(r){return r instanceof HTMLVideoElement?{width:r.videoWidth,height:r.videoHeight}:r}const ot={wrap:{s:10497,t:10497},mipmap:!0,noUnpackFlip:!1,preMultiplyAlpha:!1};export{_t as M,M as n,ct as r};
