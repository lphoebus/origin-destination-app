import{bv as Dt,ay as Rt,nj as ft,bu as Lt,b5 as Q,bb as O,bc as z,gl as jt,bd as Et,nk as mt,aW as Nt,aP as et,bg as qt,nl as Ut,da as Gt,aZ as Ot,c7 as Wt}from"./index-C2z3vZ9k.js";let Pt=class{constructor(e=null,n=null,o=null){this.minValue=e,this.maxValue=n,this.noDataValue=o}};var H;let F=H=class extends Dt{static createEmptyBand(t,e){return new(H.getPixelArrayConstructor(t))(e)}static combineBandMasks(t){if(t.length<2)return t[0];const e=t[0].length,n=new Uint8Array(e).fill(255);for(let o=0;o<t.length;o++){const r=t[o];for(let i=0;i<e;i++)r[i]||(n[i]=0)}return n}static getPixelArrayConstructor(t){let e;switch(t){case"u1":case"u2":case"u4":case"u8":e=Uint8Array;break;case"u16":e=Uint16Array;break;case"u32":e=Uint32Array;break;case"s8":e=Int8Array;break;case"s16":e=Int16Array;break;case"s32":e=Int32Array;break;case"f32":case"c64":case"c128":case"unknown":e=Float32Array;break;case"f64":e=Float64Array}return e}constructor(t){super(t),this.width=null,this.height=null,this.pixelType="f32",this.validPixelCount=null,this.mask=null,this.maskIsAlpha=!1,this.premultiplyAlpha=!1,this.statistics=null,this.depthCount=1}castPixelType(t){if(!t)return"f32";let e=t.toLowerCase();return["u1","u2","u4"].includes(e)?e="u8":["unknown","u8","s8","u16","s16","u32","s32","f32","f64"].includes(e)||(e="f32"),e}getPlaneCount(){var t;return(t=this.pixels)==null?void 0:t.length}addData(t){if(!t.pixels||t.pixels.length!==this.width*this.height)throw new Rt("pixelblock:invalid-or-missing-pixels","add data requires valid pixels array that has same length defined by pixel block width * height");this.pixels||(this.pixels=[]),this.statistics||(this.statistics=[]),this.pixels.push(t.pixels),this.statistics.push(t.statistics??new Pt)}getAsRGBA(){const t=new ArrayBuffer(this.width*this.height*4);switch(this.pixelType){case"s8":case"s16":case"u16":case"s32":case"u32":case"f32":case"f64":this._fillFromNon8Bit(t);break;default:this._fillFrom8Bit(t)}return new Uint8ClampedArray(t)}getAsRGBAFloat(){const t=new Float32Array(this.width*this.height*4);return this._fillFrom32Bit(t),t}updateStatistics(){if(!this.pixels)return;this.statistics=this.pixels.map((n=>zt(n,this.mask)));const t=this.mask;let e=0;if(t!=null)for(let n=0;n<t.length;n++)t[n]&&e++;else e=this.width*this.height;this.validPixelCount=e}clamp(t){if(!t||t==="f64"||t==="f32"||!this.pixels)return;const[e,n]=ft(t),o=this.pixels,r=this.width*this.height,i=o.length;let l,h,a;const s=[];for(let c=0;c<i;c++){a=H.createEmptyBand(t,r),l=o[c];for(let u=0;u<r;u++)h=l[u],a[u]=h>n?n:h<e?e:h;s.push(a)}this.pixels=s,this.pixelType=t}extractBands(t){var u;const{pixels:e,statistics:n}=this;if(t==null||t.length===0||!e||e.length===0)return this;const o=e.length,r=t.some((p=>p>=e.length)),i=o===t.length&&!t.some(((p,f)=>p!==f));if(r||i)return this;const l=((u=this.bandMasks)==null?void 0:u.length)===o?t.map((p=>this.bandMasks[p])):void 0;let{mask:h,validPixelCount:a}=this;const{width:s,height:c}=this;return l!=null&&l.length&&(h=H.combineBandMasks(l),a=h.filter((p=>!!p)).length),new H({pixelType:this.pixelType,width:s,height:c,mask:h,bandMasks:l,validPixelCount:a,maskIsAlpha:this.maskIsAlpha,pixels:t.map((p=>e[p])),statistics:n&&t.map((p=>n[p]))})}clone(){const t=new H({width:this.width,height:this.height,pixelType:this.pixelType,maskIsAlpha:this.maskIsAlpha,validPixelCount:this.validPixelCount});let e;this.mask!=null&&(t.mask=new Uint8Array(this.mask)),this.bandMasks&&(t.bandMasks=this.bandMasks.map((o=>new Uint8Array(o))));const n=H.getPixelArrayConstructor(this.pixelType);if(this.pixels&&this.pixels.length>0){t.pixels=[];const o=!!this.pixels[0].slice;for(e=0;e<this.pixels.length;e++)t.pixels[e]=o?this.pixels[e].slice():new n(this.pixels[e])}if(this.statistics)for(t.statistics=[],e=0;e<this.statistics.length;e++)t.statistics[e]=Lt(this.statistics[e]);return t.premultiplyAlpha=this.premultiplyAlpha,t}_fillFrom8Bit(t){const{mask:e,maskIsAlpha:n,premultiplyAlpha:o,pixels:r}=this;if(!t||!(r!=null&&r.length))return void Q.getLogger(this).error("getAsRGBA()","Unable to convert to RGBA. The input pixel block is empty.");let i,l,h,a;i=l=h=r[0],r.length>=3?(l=r[1],h=r[2]):r.length===2&&(l=r[1]);const s=new Uint32Array(t),c=this.width*this.height;if(i.length===c)if(e!=null&&e.length===c)if(n)for(a=0;a<c;a++){const u=e[a];if(u){const p=u/255;s[a]=o?u<<24|h[a]*p<<16|l[a]*p<<8|i[a]*p:u<<24|h[a]<<16|l[a]<<8|i[a]}}else for(a=0;a<c;a++)e[a]&&(s[a]=255<<24|h[a]<<16|l[a]<<8|i[a]);else for(a=0;a<c;a++)s[a]=255<<24|h[a]<<16|l[a]<<8|i[a];else Q.getLogger(this).error("getAsRGBA()","Unable to convert to RGBA. The pixelblock is invalid.")}_fillFromNon8Bit(t){const{pixels:e,mask:n,statistics:o}=this;if(!t||!(e!=null&&e.length))return void Q.getLogger(this).error("getAsRGBA()","Unable to convert to RGBA. The input pixel block is empty.");const r=this.pixelType;let i=1,l=0,h=1;if(o&&o.length>0){for(const m of o)if(m.minValue!=null&&(l=Math.min(l,m.minValue)),m.maxValue!=null&&m.minValue!=null){const g=m.maxValue-m.minValue;h=Math.max(h,g)}i=255/h}else{let m=255;r==="s8"?(l=-128,m=127):r==="u16"?m=65535:r==="s16"?(l=-32768,m=32767):r==="u32"?m=4294967295:r==="s32"?(l=-2147483648,m=2147483647):r==="f32"?(l=-34e38,m=34e38):r==="f64"&&(l=-Number.MAX_VALUE,m=Number.MAX_VALUE),i=255/(m-l)}const a=new Uint32Array(t),s=this.width*this.height;let c,u,p,f,d;if(c=u=p=e[0],c.length!==s)return Q.getLogger(this).error("getAsRGBA()","Unable to convert to RGBA. The pixelblock is invalid.");if(e.length>=2)if(u=e[1],e.length>=3&&(p=e[2]),n!=null&&n.length===s)for(f=0;f<s;f++)n[f]&&(a[f]=255<<24|(p[f]-l)*i<<16|(u[f]-l)*i<<8|(c[f]-l)*i);else for(f=0;f<s;f++)a[f]=255<<24|(p[f]-l)*i<<16|(u[f]-l)*i<<8|(c[f]-l)*i;else if(n!=null&&n.length===s)for(f=0;f<s;f++)d=(c[f]-l)*i,n[f]&&(a[f]=255<<24|d<<16|d<<8|d);else for(f=0;f<s;f++)d=(c[f]-l)*i,a[f]=255<<24|d<<16|d<<8|d}_fillFrom32Bit(t){const{pixels:e,mask:n}=this;if(!t||!(e!=null&&e.length))return Q.getLogger(this).error("getAsRGBAFloat()","Unable to convert to RGBA. The input pixel block is empty.");let o,r,i,l;o=r=i=e[0],e.length>=3?(r=e[1],i=e[2]):e.length===2&&(r=e[1]);const h=this.width*this.height;if(o.length!==h)return Q.getLogger(this).error("getAsRGBAFloat()","Unable to convert to RGBA. The pixelblock is invalid.");let a=0;if(n!=null&&n.length===h)for(l=0;l<h;l++)t[a++]=o[l],t[a++]=r[l],t[a++]=i[l],t[a++]=1&n[l];else for(l=0;l<h;l++)t[a++]=o[l],t[a++]=r[l],t[a++]=i[l],t[a++]=1}};function zt(t,e){let n=1/0,o=-1/0;const r=t.length;let i,l=0;if(e!=null)for(i=0;i<r;i++)e[i]&&(l=t[i],n=l<n?l:n,o=l>o?l:o);else for(i=0;i<r;i++)l=t[i],n=l<n?l:n,o=l>o?l:o;return new Pt(n,o)}O([z({json:{write:!0}})],F.prototype,"width",void 0),O([z({json:{write:!0}})],F.prototype,"height",void 0),O([z({json:{write:!0}})],F.prototype,"pixelType",void 0),O([jt("pixelType")],F.prototype,"castPixelType",null),O([z({json:{write:!0}})],F.prototype,"validPixelCount",void 0),O([z({json:{write:!0}})],F.prototype,"mask",void 0),O([z({json:{write:!0}})],F.prototype,"maskIsAlpha",void 0),O([z({json:{write:!0}})],F.prototype,"pixels",void 0),O([z()],F.prototype,"premultiplyAlpha",void 0),O([z({json:{write:!0}})],F.prototype,"statistics",void 0),O([z({json:{write:!0}})],F.prototype,"depthCount",void 0),O([z({json:{write:!0}})],F.prototype,"noDataValues",void 0),O([z({json:{write:!0}})],F.prototype,"bandMasks",void 0),F=H=O([Et("esri.layers.support.PixelBlock")],F);var gt,xt;(function(t){t[t.matchAny=0]="matchAny",t[t.matchAll=1]="matchAll"})(gt||(gt={})),(function(t){t[t.bestMatch=0]="bestMatch",t[t.fail=1]="fail"})(xt||(xt={}));const wt=9;function R(t){var e;return t!=null&&((e=t.pixels)==null?void 0:e.length)>0}function ge(t){var c;if(!(t!=null&&t.length)||t.some((u=>!R(u))))return null;if(t.length===1)return((c=t[0])==null?void 0:c.clone())??null;const e=t,{width:n,height:o,pixelType:r}=e[0];if(e.some((u=>u.width!==n||u.height!==o)))return null;const i=e.map((({mask:u})=>u)).filter((u=>u!=null));let l=null;i.length&&(l=new Uint8Array(n*o),l.set(i[0]),i.length>1&&It(i.slice(1),l));const h=[];e.forEach((({pixels:u})=>h.push(...u)));const a=e.map((({statistics:u})=>u)).filter((u=>u==null?void 0:u.length)),s=[];return a.forEach((u=>s.push(...u))),new F({pixelType:r,width:n,height:o,mask:l,pixels:h,statistics:s.length?s:null})}function xe(t){if(!t)return;const e=t.colormap;if(!e||e.length===0)return;const n=e.sort(((a,s)=>a[0]-s[0])),o=n[0][0]<0?n[0][0]:0,r=Math.max(256,n[n.length-1][0]-o+1),i=new Uint8Array(4*r),l=[],h=n[0].length===5;if(r>65536)return n.forEach((a=>{l[a[0]-o]=h?a.slice(1):a.slice(1).concat([255])})),{indexed2DColormap:l,offset:o,alphaSpecified:h};if(t.fillUnspecified){let a=n[0];for(let s=a[0]-o,c=0;s<r;s++)i[4*s]=a[1],i[4*s+1]=a[2],i[4*s+2]=a[3],i[4*s+3]=h?a[4]:255,s===a[0]-o&&(a=c===n.length-1?a:n[++c])}else for(let a=0;a<n.length;a++){const s=n[a],c=4*(s[0]-o);i[c]=s[1],i[c+1]=s[2],i[c+2]=s[3],i[c+3]=h?s[4]:255}return{indexedColormap:i,offset:o,alphaSpecified:h}}function we(t,e){if(!R(t)||!e||!e.indexedColormap&&!e.indexed2DColormap)return t;const n=t.clone(),o=n.pixels;let r=n.mask;const i=n.width*n.height;if(o.length!==1)return t;const{indexedColormap:l,indexed2DColormap:h,offset:a,alphaSpecified:s}=e,c=o[0],u=new Uint8Array(c.length),p=new Uint8Array(c.length),f=new Uint8Array(c.length);let d,m=0;if(l){const g=l.length-1;if(r!=null)for(let x=0;x<i;x++)r[x]&&(m=4*(c[x]-a),m<a||m>g?r[x]=0:(u[x]=l[m],p[x]=l[m+1],f[x]=l[m+2],r[x]=l[m+3]));else{r=new Uint8Array(i);for(let x=0;x<i;x++)m=4*(c[x]-a),m<a||m>g?r[x]=0:(u[x]=l[m],p[x]=l[m+1],f[x]=l[m+2],r[x]=l[m+3]);n.mask=r}}else if(h)if(r!=null)for(let g=0;g<i;g++)r[g]&&(d=h[c[g]],u[g]=d[0],p[g]=d[1],f[g]=d[2],r[g]=d[3]);else{r=new Uint8Array(i);for(let g=0;g<i;g++)d=h[c[g]],u[g]=d[0],p[g]=d[1],f[g]=d[2],r[g]=d[3];n.mask=r}return n.pixels=[u,p,f],n.statistics=null,n.pixelType="u8",n.maskIsAlpha=s,n}function ye(t,e){if(!R(t))return null;const{pixels:n,mask:o}=t,r=n.length;let i=e.lut;const{offset:l}=e;i&&i[0].length===1&&(i=n.map((()=>i)));const h=[],a=e.outputPixelType||"u8";for(let c=0;c<r;c++){const u=Tt(n[c],o,i[c],l||0,a);h.push(u)}const s=new F({width:t.width,height:t.height,pixels:h,mask:o,pixelType:a});return s.updateStatistics(),s}function Tt(t,e,n,o,r){const i=t.length,l=F.createEmptyBand(r,i);if(e)for(let h=0;h<i;h++)e[h]&&(l[h]=n[t[h]-o]);else for(let h=0;h<i;h++)l[h]=n[t[h]-o];return l}function ke(t,e){if(!R(t))return null;const n=t.clone(),{pixels:o}=n,r=n.width*n.height,i=e.length,l=Math.floor(i/2),h=e[Math.floor(l)],a=o[0],s=new Uint8Array(r),c=new Uint8Array(r),u=new Uint8Array(r);let p=n.mask;const f=e[0].mappedColor.length===4;p||(p=new Uint8Array(r),p.fill(f?255:1),n.mask=p);for(let d=0;d<r;d++)if(p[d]){const m=a[d];let g=!1,x=l,k=h,M=0,A=i-1;for(;A-M>1;){if(m===k.value){g=!0;break}m>k.value?M=x:A=x,x=Math.floor((M+A)/2),k=e[Math.floor(x)]}g||(m===e[M].value?(k=e[M],g=!0):m===e[A].value?(k=e[A],g=!0):m<e[M].value?g=!1:m>e[M].value&&(m<e[A].value?(k=e[M],g=!0):A===i-1?g=!1:(k=e[A],g=!0))),g?(s[d]=k.mappedColor[0],c[d]=k.mappedColor[1],u[d]=k.mappedColor[2],p[d]=k.mappedColor[3]):s[d]=c[d]=u[d]=p[d]=0}return n.pixels=[s,c,u],n.mask=p,n.pixelType="u8",n.maskIsAlpha=f,n}function Me(t,e,n=!1){const r=new Float32Array(3*wt),i=e.length;for(let l=0;l<wt;l++)r[3*l]=t[2*l]??mt-1,r[3*l+1]=t[2*l+1]??mt,r[3*l+2]=e[l]??0,l<i&&(l>0&&(r[3*l]-=1e-5),t[2*l+1]!==t[2*l]&&(l<i-1||!n)&&(r[3*l+1]-=1e-5));return r}function Ae(t,e){if(!R(t))return null;const{width:n,height:o}=t,{inputRanges:r,outputValues:i,outputPixelType:l,noDataRanges:h,allowUnmatched:a,replacementValue:s,isLastInputRangeInclusive:c}=e,u=t.pixels[0],p=F.createEmptyBand(l,u.length),f=t.mask,d=new Uint8Array(n*o);f?d.set(f):d.fill(255);const m=t.pixelType.startsWith("f")?1e-6:0,g=r.map((w=>w-m));g[0]=r[0],g[g.length-1]=r[r.length-1]+(c?1e-6:0);const x=r.length/2,[k,M]=ft(l);for(let w=0;w<o;w++)for(let y=0;y<n;y++){const U=w*n+y;if(d[U]){const b=u[U];let I=!1;for(let T=x-1;T>=0;T--)if(b===r[2*T]||b>g[2*T]&&b<g[2*T+1]){p[U]=i[T],I=!0;break}I||(a?p[U]=b>M?M:b<k?k:s??b:d[U]=0)}}const A=h==null?void 0:h.length;if(A)for(let w=0;w<o;w++)for(let y=0;y<n;y++){const U=w*n+y;if(!f||f[U]){const b=u[U];for(let I=0;I<A;I+=2)if(b>=h[I]&&b<=h[I+1]){p[U]=0,d[U]=0;break}}}return new F({width:n,height:o,pixelType:l,pixels:[p],mask:d})}function yt(t,e,n,o){const r=n!=null&&n.length>=2?new Set(n):null,i=(n==null?void 0:n.length)===1?n[0]:null,l=!!(e!=null&&e.length);for(let h=0;h<t.length;h++)if(o[h]){const a=t[h];if(l){let s=!1;for(let c=0;c<e.length;c+=2)if(a>=e[c]&&a<=e[c+1]){s=!0;break}s||(o[h]=0)}o[h]&&(a===i||r!=null&&r.has(a))&&(o[h]=0)}}function kt(t,e){const n=t[0].length;for(let o=0;o<n;o++)if(e[o]){let r=!1;for(let i=0;i<t.length;i++)if(t[i][o]){r=!0;break}r||(e[o]=0)}}function It(t,e){const n=t[0].length;for(let o=0;o<n;o++)if(e[o]){let r=!1;for(let i=0;i<t.length;i++)if(t[i][o]===0){r=!0;break}r&&(e[o]=0)}}function be(t,e){if(!R(t))return null;const{width:n,height:o,pixels:r}=t,i=n*o,l=new Uint8Array(i);t.mask?l.set(t.mask):l.fill(255);const h=r.length,{includedRanges:a,noDataValues:s,outputPixelType:c,matchAll:u,lookups:p}=e;if(p){const f=[];for(let d=0;d<h;d++){const m=p[d],g=Tt(r[d],l,m.lut,m.offset||0,"u8");f.push(g)}f.length===1?l.set(f[0]):u?kt(f,l):It(f,l)}else if(u){const f=[];for(let d=0;d<h;d++){const m=new Uint8Array(i);m.set(l),yt(r[d],a==null?void 0:a.slice(2*d,2*d+2),s==null?void 0:s[d],m),f.push(m)}f.length===1?l.set(f[0]):kt(f,l)}else for(let f=0;f<h;f++)yt(r[f],a==null?void 0:a.slice(2*f,2*f+2),s==null?void 0:s[f],l);return new F({width:n,height:o,pixelType:c,pixels:r,mask:l})}function ve(t){const{srcPixelType:e,inputRanges:n,outputValues:o,allowUnmatched:r,noDataRanges:i,isLastInputRangeInclusive:l,outputPixelType:h}=t;if(e!=="u8"&&e!=="s8"&&e!=="u16"&&e!=="s16")return null;const a=e.includes("16")?65536:256,s=e.includes("s")?-a/2:0,c=F.createEmptyBand(h,a),u=new Uint8Array(a);r&&u.fill(255);const[p,f]=ft(h);if(n!=null&&n.length&&(o!=null&&o.length)){const m=n.map((g=>g-1e-6));m[0]=n[0],l&&(m[m.length-1]=n[n.length-1]);for(let g=0;g<m.length;g++){const x=o[g]>f?f:o[g]<p?p:o[g],k=Math.ceil(m[2*g]-s),M=n[2*g+1]===n[2*g]?k:Math.floor(m[2*g+1]-s);for(let A=k;A<=M;A++)c[A]=x,u[A]=255}}if(i!=null&&i.length)for(let d=0;d<i.length;d++){const m=Math.ceil(i[2*d]-s),g=Math.floor(i[2*d+1]-s);for(let x=m;x<=g;x++)u[x]=0}return{lut:c,offset:s,mask:u}}function Ue(t,e,n){if(t!=="u8"&&t!=="s8"&&t!=="u16"&&t!=="s16")return null;const o=t.includes("16")?65536:256,r=t.includes("s")?-o/2:0,i=new Uint8Array(o);if(e)for(let l=0;l<e.length;l++){const h=Math.ceil(e[2*l]-r),a=Math.floor(e[2*l+1]-r);for(let s=h;s<=a;s++)i[s]=255}else i.fill(255);if(n)for(let l=0;l<n.length;l++)i[n[l]-r]=0;return{lut:i,offset:r}}function Jt(t,e,n,o,r,i,l,h){return{xmin:r<=n*t?0:r<n*t+t?r-n*t:t,ymin:i<=o*e?0:i<o*e+e?i-o*e:e,xmax:r+l<=n*t?0:r+l<n*t+t?r+l-n*t:t,ymax:i+h<=o*e?0:i+h<o*e+e?i+h-o*e:e}}function Pe(t,e){if(!t||t.length===0)return null;const n=t.find((d=>d.pixelBlock));if((n==null?void 0:n.pixelBlock)==null)return null;const o=(n.extent.xmax-n.extent.xmin)/n.pixelBlock.width,r=(n.extent.ymax-n.extent.ymin)/n.pixelBlock.height,i=.01*Math.min(o,r),l=t.sort(((d,m)=>Math.abs(d.extent.ymax-m.extent.ymax)>i?m.extent.ymax-d.extent.ymax:Math.abs(d.extent.xmin-m.extent.xmin)>i?d.extent.xmin-m.extent.xmin:0)),h=Math.min.apply(null,l.map((d=>d.extent.xmin))),a=Math.min.apply(null,l.map((d=>d.extent.ymin))),s=Math.max.apply(null,l.map((d=>d.extent.xmax))),c=Math.max.apply(null,l.map((d=>d.extent.ymax))),u={x:Math.round((e.xmin-h)/o),y:Math.round((c-e.ymax)/r)},p={width:Math.round((s-h)/o),height:Math.round((c-a)/r)},f={width:Math.round((e.xmax-e.xmin)/o),height:Math.round((e.ymax-e.ymin)/r)};return Math.round(p.width/n.pixelBlock.width)*Math.round(p.height/n.pixelBlock.height)!==l.length||u.x<0||u.y<0||p.width<f.width||p.height<f.height?null:{extent:e,pixelBlock:Xt(l.map((d=>d.pixelBlock)),p,{clipOffset:u,clipSize:f})}}function ht(t,e,n,o,r,i){const{width:l,height:h}=n.block,{x:a,y:s}=n.offset,{width:c,height:u}=n.mosaic,p=Jt(l,h,o,r,a,s,c,u);let f=0,d=0;if(i){const m=i.hasGCSSShiftTransform?360:i.halfWorldWidth??0,g=l*i.resolutionX,x=i.startX+o*g;x<m&&x+g>m?d=i.rightPadding:x>=m&&(f=i.leftMargin-i.rightPadding,d=0)}if(p.xmax-=d,typeof e!="number")for(let m=p.ymin;m<p.ymax;m++){const g=(r*h+m-s)*c+(o*l-a)+f,x=m*l;for(let k=p.xmin;k<p.xmax;k++)t[g+k]=e[x+k]}else for(let m=p.ymin;m<p.ymax;m++){const g=(r*h+m-s)*c+(o*l-a)+f;for(let x=p.xmin;x<p.xmax;x++)t[g+x]=e}}function Xt(t,e,n={}){var T;const{clipOffset:o,clipSize:r,alignmentInfo:i,blockWidths:l}=n;if(l)return Ht(t,e,{blockWidths:l});const h=t.find((P=>R(P)));if(h==null)return null;const a=r?r.width:e.width,s=r?r.height:e.height,c=h.width,u=h.height,p=e.width/c,f=e.height/u,d={offset:o||{x:0,y:0},mosaic:r||e,block:{width:c,height:u}},m=h.pixelType,g=F.getPixelArrayConstructor(m),x=h.pixels.length,k=[];let M,A;for(let P=0;P<x;P++){A=new g(a*s);for(let v=0;v<f;v++)for(let B=0;B<p;B++){const C=t[v*p+B];R(C)&&(M=C.pixels[P],ht(A,M,d,B,v,i))}k.push(A)}const w=t.some((P=>P==null||P.mask!=null&&P.mask.length>0)),y=t.some((P=>(P==null?void 0:P.bandMasks)&&P.bandMasks.length>1)),U=w?new Uint8Array(a*s):void 0,b=y?[]:void 0;if(U){for(let P=0;P<f;P++)for(let v=0;v<p;v++){const B=t[P*p+v],C=B!=null?B.mask:null;ht(U,C??(B?255:0),d,v,P,i)}if(b)for(let P=0;P<x;P++){const v=new Uint8Array(a*s);for(let B=0;B<f;B++)for(let C=0;C<p;C++){const S=t[B*p+C],$=((T=S==null?void 0:S.bandMasks)==null?void 0:T[P])??(S==null?void 0:S.mask);ht(v,$??(S?255:0),d,C,B,i)}b.push(v)}}const I=new F({width:a,height:s,pixels:k,pixelType:m,bandMasks:b,mask:U});return I.updateStatistics(),I}function Ht(t,e,n){var g;const o=t.find((x=>x!=null));if(o==null)return null;const r=t.some((x=>x==null||!!x.mask)),{width:i,height:l}=e,h=r?new Uint8Array(i*l):null,{blockWidths:a}=n,s=[],c=o.getPlaneCount(),u=F.getPixelArrayConstructor(o.pixelType);if(r)for(let x=0,k=0;x<t.length;k+=a[x],x++){const M=t[x];if(!R(M))continue;const A=M.mask;for(let w=0;w<l;w++)for(let y=0;y<a[x];y++)h[w*i+y+k]=A==null?255:A[w*M.width+y]}const p=t.some((x=>(x==null?void 0:x.bandMasks)&&x.bandMasks.length>1)),f=p?[]:void 0,d=i*l;for(let x=0;x<c;x++){const k=new u(d),M=p?new Uint8Array(d):void 0;for(let A=0,w=0;A<t.length;w+=a[A],A++){const y=t[A];if(!R(y))continue;const U=y.pixels[x];if(U!=null){for(let b=0;b<l;b++)for(let I=0;I<a[A];I++)k[b*i+I+w]=U[b*y.width+I];if(M){const b=((g=y.bandMasks)==null?void 0:g[x])??y.mask;for(let I=0;I<l;I++)for(let T=0;T<a[A];T++)M[I*i+T+w]=b?b[I*y.width+T]:255}}}s.push(k),f&&M&&f.push(M)}const m=new F({width:i,height:l,mask:h,bandMasks:f,pixels:s,pixelType:o.pixelType});return m.updateStatistics(),m}function Te(t,e,n){if(!R(t))return null;const{width:o,height:r}=t,i=e.x,l=e.y,h=n.width+i,a=n.height+l;if(i<0||l<0||h>o||a>r||i===0&&l===0&&h===o&&a===r)return t;t.mask||(t.mask=new Uint8Array(o*r));const s=t.mask;for(let c=0;c<r;c++){const u=c*o;for(let p=0;p<o;p++)s[u+p]=c<l||c>=a||p<i||p>=h?0:1}return t.updateStatistics(),t}function Kt(t){if(!R(t))return null;const e=t.clone(),{width:n,height:o,pixels:r}=t,i=r[0],l=e.pixels[0],h=t.mask;for(let a=2;a<o-1;a++){const s=new Map;for(let u=a-2;u<a+2;u++)for(let p=0;p<4;p++){const f=u*n+p;lt(s,i[f],h?h[f]:1)}l[a*n]=Mt(s),l[a*n+1]=l[a*n+2]=l[a*n];let c=3;for(;c<n-1;c++){let u=(a-2)*n+c+1;lt(s,i[u],h?h[u]:1),u=(a-1)*n+c+1,lt(s,i[u],h?h[u]:1),u=a*n+c+1,lt(s,i[u],h?h[u]:1),u=(a+1)*n+c+1,lt(s,i[u],h?h[u]:1),u=(a-2)*n+c-3,st(s,i[u],h?h[u]:1),u=(a-1)*n+c-3,st(s,i[u],h?h[u]:1),u=a*n+c-3,st(s,i[u],h?h[u]:1),u=(a+1)*n+c-3,st(s,i[u],h?h[u]:1),l[a*n+c]=Mt(s)}l[a*n+c+1]=l[a*n+c]}for(let a=0;a<n;a++)l[a]=l[n+a]=l[2*n+a],l[(o-1)*n+a]=l[(o-2)*n+a];return e.updateStatistics(),e}function Mt(t){if(t.size===0)return 0;let e=0,n=-1,o=0;const r=t.keys();let i=r.next();for(;!i.done;)o=t.get(i.value),o>e&&(n=i.value,e=o),i=r.next();return n}function st(t,e,n){if(n===0)return;const o=t.get(e);o===1?t.delete(e):t.set(e,o-1)}function lt(t,e,n){n!==0&&t.set(e,t.has(e)?t.get(e)+1:1)}function $t(t,e,n){let{x:o,y:r}=e;const{width:i,height:l}=n;if(o===0&&r===0&&l===t.height&&i===t.width)return t;const{width:h,height:a}=t,s=Math.max(0,r),c=Math.max(0,o),u=Math.min(o+i,h),p=Math.min(r+l,a);if(u<0||p<0||!R(t))return null;o=Math.max(0,-o),r=Math.max(0,-r);const{pixels:f}=t,d=i*l,m=f.length,g=[];for(let A=0;A<m;A++){const w=f[A],y=F.createEmptyBand(t.pixelType,d);for(let U=s;U<p;U++){const b=U*h;let I=(U+r-s)*i+o;for(let T=c;T<u;T++)y[I++]=w[b+T]}g.push(y)}const x=new Uint8Array(d),k=t.mask;for(let A=s;A<p;A++){const w=A*h;let y=(A+r-s)*i+o;for(let U=c;U<u;U++)x[y++]=k?k[w+U]:1}const M=new F({width:n.width,height:n.height,pixelType:t.pixelType,pixels:g,mask:x});return M.updateStatistics(),M}function Bt(t,e=!0){if(!R(t))return null;const{pixels:n,width:o,height:r,mask:i,pixelType:l}=t,h=[],a=Math.round(o/2),s=Math.round(r/2),c=r-1,u=o-1;for(let f=0;f<n.length;f++){const d=n[f],m=F.createEmptyBand(l,a*s);let g=0;for(let x=0;x<r;x+=2)for(let k=0;k<o;k+=2){const M=d[x*o+k];if(e){const A=k===u?M:d[x*o+k+1],w=x===c?M:d[x*o+k+o],y=k===u?w:x===c?A:d[x*o+k+o+1];m[g++]=(M+A+w+y)/4}else m[g++]=M}h.push(m)}let p=null;if(i!=null){p=new Uint8Array(a*s);let f=0;for(let d=0;d<r;d+=2)for(let m=0;m<o;m+=2){const g=i[d*o+m];if(e){const x=m===u?g:i[d*o+m+1],k=d===c?g:i[d*o+m+o],M=m===u?k:d===c?x:i[d*o+m+o+1];p[f++]=g*x*k*M?1:0}else p[f++]=g}}return new F({width:a,height:s,pixelType:l,pixels:h,mask:p})}function Ie(t,e,n=0,o=!0){if(!R(t))return null;const{width:r,height:i}=e;let{width:l,height:h}=t;const a=new Map,s={x:0,y:0},c=1+n;let u=t;for(let p=0;p<c;p++){const f=Math.ceil(l/r),d=Math.ceil(h/i);for(let m=0;m<d;m++){s.y=m*i;for(let g=0;g<f;g++){s.x=g*r;const x=$t(u,s,e);a.set(`${p}/${m}/${g}`,x)}}p<c-1&&(u=Bt(u,o)),l=Math.round(l/2),h=Math.round(h/2)}return a}function $e(t){const{pixelBlock:e,tileSize:n,level:o,row:r,col:i,useBilinear:l}=t;if(!R(e))return null;const{width:h,height:a}=n,s=2**o,c=s*h,u=s*a;let p=$t(e,{y:r*u,x:i*c},{width:c,height:u});if(!p)return null;for(let f=o;f>0;f--)p=Bt(p,l);return p}function St(t,e,n,o,r=0){const{width:i,height:l}=t,{width:h,height:a}=e,s=o.cols,c=o.rows,u=Math.ceil(h/s-.1/s),p=Math.ceil(a/c-.1/c);let f,d,m,g,x,k,M;const A=u*s,w=A*p*c,y=new Float32Array(w),U=new Float32Array(w),b=new Uint32Array(w),I=new Uint32Array(w);let T,P,v=0;for(let B=0;B<p;B++)for(let C=0;C<u;C++){f=12*(B*u+C),d=n[f],m=n[f+1],g=n[f+2],x=n[f+3],k=n[f+4],M=n[f+5];for(let S=0;S<c;S++){v=(B*c+S)*A+C*s,P=(S+.5)/c;for(let $=0;$<S;$++)T=($+.5)/s,y[v+$]=(d*T+m*P+g)*i+r,U[v+$]=(x*T+k*P+M)*l+r,b[v+$]=Math.floor(y[v+$]),I[v+$]=Math.floor(U[v+$])}f+=6,d=n[f],m=n[f+1],g=n[f+2],x=n[f+3],k=n[f+4],M=n[f+5];for(let S=0;S<c;S++){v=(B*c+S)*A+C*s,P=(S+.5)/c;for(let $=S;$<s;$++)T=($+.5)/s,y[v+$]=(d*T+m*P+g)*i+r,U[v+$]=(x*T+k*P+M)*l+r,b[v+$]=Math.floor(y[v+$]),I[v+$]=Math.floor(U[v+$])}}return{offsets_x:y,offsets_y:U,offsets_xi:b,offsets_yi:I,gridWidth:A}}function Be(t,e){const{coefficients:n,spacing:o}=e,{offsets_x:r,offsets_y:i,gridWidth:l}=St(t,t,n,{rows:o[0],cols:o[1]}),{width:h,height:a}=t,s=new Float32Array(h*a),c=180/Math.PI;for(let u=0;u<a;u++)for(let p=0;p<h;p++){const f=u*l+p,d=u===0?f:f-l,m=u===a-1?f:f+l,g=r[d]-r[m],x=i[m]-i[d];if(isNaN(g)||isNaN(x))s[u*h+p]=90;else{let k=Math.atan2(x,g)*c;k=(360+k)%360,s[u*h+p]=k}}return s}function Se(t,e,n,o,r="nearest"){if(!R(t))return null;r==="majority"&&(t=Kt(t));const{pixels:i,mask:l,bandMasks:h,pixelType:a}=t,s=t.width,c=t.height,u=F.getPixelArrayConstructor(a),p=i.length,{width:f,height:d}=e;let m=!1;for(let v=0;v<n.length;v+=3)n[v]===-1&&n[v+1]===-1&&n[v+2]===-1&&(m=!0);const{offsets_x:g,offsets_y:x,offsets_xi:k,offsets_yi:M,gridWidth:A}=St({width:s,height:c},e,n,o,r==="majority"?.5:0);let w;const y=(v,B,C,S)=>{const $=v instanceof Float32Array||v instanceof Float64Array?0:.5;for(let V=0;V<d;V++){w=V*A;for(let _=0;_<f;_++){if(g[w]<0||x[w]<0)v[V*f+_]=0;else if(S)v[V*f+_]=B[k[w]+M[w]*s];else{const E=Math.floor(g[w]),G=Math.floor(x[w]),L=Math.ceil(g[w]),q=Math.ceil(x[w]),W=g[w]-E,X=x[w]-G;if(!C||C[E+G*s]&&C[L+G*s]&&C[E+q*s]&&C[L+q*s]){const tt=(1-W)*B[E+G*s]+W*B[L+G*s],K=(1-W)*B[E+q*s]+W*B[L+q*s];v[V*f+_]=(1-X)*tt+X*K+$}else v[V*f+_]=B[k[w]+M[w]*s]}w++}}},U=[];let b;const I=(h==null?void 0:h.length)===p,T=[];for(let v=0;v<p;v++){if(I){const B=new Uint8Array(f*d);y(B,h[v],h[v],!0),T.push(B)}b=new u(f*d),y(b,i[v],I?h[v]:l,r==="nearest"||r==="majority"),U.push(b)}const P=new F({width:f,height:d,pixelType:a,pixels:U,bandMasks:I?T:void 0});if(l!=null)P.mask=new Uint8Array(f*d),y(P.mask,l,l,!0);else if(m){P.mask=new Uint8Array(f*d);for(let v=0;v<f*d;v++)P.mask[v]=g[v]<0||x[v]<0?0:1}return P.updateStatistics(),P}const Y=new Map;Y.set("meter-per-second",1),Y.set("kilometer-per-hour",.277778),Y.set("knots",.514444),Y.set("feet-per-second",.3048),Y.set("mile-per-hour",.44704);const ut=180/Math.PI,pt=5,ot=new Nt({esriMetersPerSecond:"meter-per-second",esriKilometersPerHour:"kilometer-per-hour",esriKnots:"knots",esriFeetPerSecond:"feet-per-second",esriMilesPerHour:"mile-per-hour"});function dt(t,e){return Y.get(t)/Y.get(e)||1}function Ft(t){return(450-t)%360}function Ct(t,e="geographic"){const[n,o]=t,r=Math.sqrt(n*n+o*o);let i=Math.atan2(o,n)*ut;return i=(360+i)%360,e==="geographic"&&(i=Ft(i)),[r,i]}function Zt(t,e="geographic"){let n=t[1];e==="geographic"&&(n=Ft(n)),n%=360;const o=t[0];return[o*Math.cos(n/ut),o*Math.sin(n/ut)]}function Fe(t,e,n,o="geographic"){if(!R(t)||n==null)return t;const r=e==="vector-magdir"?t.clone():At(t,e),i=r.pixels[1];for(let l=0;l<i.length;l++)i[l]=o==="geographic"?(i[l]+n[l]+270)%360:(i[l]+360-n[l])%360;return e==="vector-magdir"?r:At(r,"vector-magdir")}function At(t,e,n="geographic",o=1){if(!R(t))return t;const{pixels:r,width:i,height:l}=t,h=i*l,a=r[0],s=r[1],c=t.pixelType.startsWith("f")?t.pixelType:"f32",u=F.createEmptyBand(c,h),p=F.createEmptyBand(c,h);let f=0;for(let m=0;m<l;m++)for(let g=0;g<i;g++)e==="vector-uv"?([u[f],p[f]]=Ct([a[f],s[f]],n),u[f]*=o):([u[f],p[f]]=Zt([a[f],s[f]],n),u[f]*=o,p[f]*=o),f++;const d=new F({pixelType:c,width:t.width,height:t.height,mask:t.mask,validPixelCount:t.validPixelCount,maskIsAlpha:t.maskIsAlpha,pixels:[u,p]});return d.updateStatistics(),d}function Ce(t,e,n=1){if(n===1||!R(t))return t;const o=t.clone(),{pixels:r,width:i,height:l}=o,h=r[0];r[1];let a=0;for(let s=0;s<l;s++)for(let c=0;c<i;c++)h[a]*=n,a++;return o.updateStatistics(),o}function Ve(t,e,n,o,r){if(r==null||!r.spatialReference.equals(t.spatialReference))return{extent:t,width:Math.round(e/o),height:Math.round(n/o),resolution:t.width/e};const i=r.xmin,l=r.ymax,h=(t.xmax-t.xmin)/e*o,a=(t.ymax-t.ymin)/n*o,s=(h+a)/2;return t.xmin=i+Math.floor((t.xmin-i)/h)*h,t.xmax=i+Math.ceil((t.xmax-i)/h)*h,t.ymin=l+Math.floor((t.ymin-l)/a)*a,t.ymax=l+Math.ceil((t.ymax-l)/a)*a,{extent:t,width:Math.round(t.width/h),height:Math.round(t.height/a),resolution:s}}const Qt=Vt(0,0,0);function Vt(t=0,e=0,n=Math.PI,o=!0){o&&(n=(2*Math.PI-n)%(2*Math.PI));const r=o?-1:1,i=13*r,l=-7*r,h=-2*r,a=-16*r,s=21.75,[c,u]=N(0,e+i,n,s),[p,f]=N(t-5.5,e+l,n,s),[d,m]=N(t+5.5,e+l,n,s),[g,x]=N(t-1.5,e+h,n,s),[k,M]=N(t+1.5,e+h,n,s),[A,w]=N(t-1.5,e+a,n,s),[y,U]=N(t+1.5,e+a,n,s);return[c,u,p,f,g,x,k,M,d,m,A,w,y,U]}function Yt(t=0,e=Math.PI,n=!0){n&&(e=(2*Math.PI-e)%(2*Math.PI));const o=10,r=n?-1:1,i=5*r,l=20*r,h=25*r,a=45,s=0,c=0,u=2,p=0,f=u*r,d=n?1:-1,m=o/2*d;let[g,x]=[s+m,c-l],[k,M]=[g+u*d,x],[A,w]=[k-p*d,M+f],[y,U]=[s-m,c-h],[b,I]=[y+p*d,U-f],T=Math.ceil(t/pt),P=Math.floor(T/10);T-=8*P;const v=[],B=[];for(let W=0;W<T/2;W++,P--){P<=0&&T%2==1&&W===(T-1)/2&&(y=s,b=y+p*d,U=(U+x)/2,I=U-f);const[X,tt]=N(y,U,e,a);if(P>0){const[K,nt]=N(k,U,e,a),[it,D]=N(g,x,e,a);v.push(K),v.push(nt),v.push(X),v.push(tt),v.push(it),v.push(D)}else{const[K,nt]=N(k,M,e,a),[it,D]=N(A,w,e,a),[j,at]=N(b,I,e,a);B.push(X),B.push(tt),B.push(j),B.push(at),B.push(it),B.push(D),B.push(K),B.push(nt)}U+=i,x+=i,M+=i,w+=i,I+=i}const[C,S]=N(s+m,c+l,e,a),$=(o/2+u)*d,[V,_]=N(s+$,c+l,e,a),[E,G]=N(s+m,c-h,e,a),[L,q]=N(s+$,c-h,e,a);return{pennants:v,barbs:B,shaft:[C,S,V,_,E,G,L,q]}}function N(t,e,n,o=1){const r=Math.sqrt(t*t+e*e)/o,i=(2*Math.PI+Math.atan2(e,t))%(2*Math.PI);return[r,(2*Math.PI+i-n)%(2*Math.PI)]}const rt=[0,1,3,6,10,16,21,27,33,40,47,55,63],te=[0,.5,1,1.5,2],ee=[0,.25,.5,1,1.5,2,2.5,3,3.5,4];function Z(t,e,n,o){const r=dt(o||"knots",n);let i;for(i=1;i<e.length;i++)if(i===e.length-1){if(t<e[i]*r)break}else if(t<=e[i]*r)break;return Math.min(i-1,e.length-2)}function ne(t,e,n,o,r){let i=0;switch(e){case"beaufort_kn":i=Z(t,rt,"knots",n);break;case"beaufort_km":i=Z(t,rt,"kilometer-per-hour",n);break;case"beaufort_ft":i=Z(t,rt,"feet-per-second",n);break;case"beaufort_m":i=Z(t,rt,"meter-per-second",n);break;case"classified_arrow":i=Z(t,r??[],o,n);break;case"ocean_current_m":i=Z(t,te,"meter-per-second",n);break;case"ocean_current_kn":i=Z(t,ee,"knots",n)}return i}function ie(t,e){const{style:n,inputUnit:o,outputUnit:r,breakValues:i}=e,l=ot.fromJSON(o),h=ot.fromJSON(r),a=42,s=15;let c=0,u=0;const{width:p,height:f,mask:d}=t,m=t.pixels[0],g=t.pixels[1],x=d!=null?d.filter((w=>w>0)).length:p*f,k=new Float32Array(x*a),M=new Uint32Array(s*x),A=e.invertDirection?Vt(0,0,0,!1):Qt;for(let w=0;w<f;w++)for(let y=0;y<p;y++){const U=w*p+y;if(!d||d[w*p+y]){const b=(g[U]+360)%360/180*Math.PI,I=ne(m[U],n,l,h,i);for(let P=0;P<A.length;P+=2)k[c++]=(y+.5)/p,k[c++]=(w+.5)/f,k[c++]=A[P],k[c++]=A[P+1]+b,k[c++]=I,k[c++]=m[U];const T=7*(c/a-1);M[u++]=T,M[u++]=T+1,M[u++]=T+2,M[u++]=T+0,M[u++]=T+4,M[u++]=T+3,M[u++]=T+0,M[u++]=T+2,M[u++]=T+3,M[u++]=T+2,M[u++]=T+5,M[u++]=T+3,M[u++]=T+5,M[u++]=T+6,M[u++]=T+3}}return{vertexData:k,indexData:M}}const ct=[];function le(t,e){if(ct.length===0)for(let f=0;f<30;f++)ct.push(Yt(5*f,0,!e.invertDirection));const n=dt(ot.fromJSON(e.inputUnit),"knots"),{width:o,height:r,mask:i}=t,l=t.pixels[0],h=t.pixels[1],a=6,s=[],c=[];let u=0,p=0;for(let f=0;f<r;f++)for(let d=0;d<o;d++){const m=f*o+d,g=l[m]*n;if((!i||i[f*o+d])&&g>=pt){const x=(h[m]+360)%360/180*Math.PI,{pennants:k,barbs:M,shaft:A}=ct[Math.min(Math.floor(g/5),29)];if(k.length+M.length===0)continue;let w=s.length/a;const y=(d+.5)/o,U=(f+.5)/r;for(let b=0;b<k.length;b+=2)s[u++]=y,s[u++]=U,s[u++]=k[b],s[u++]=k[b+1]+x,s[u++]=0,s[u++]=g;for(let b=0;b<M.length;b+=2)s[u++]=y,s[u++]=U,s[u++]=M[b],s[u++]=M[b+1]+x,s[u++]=0,s[u++]=g;for(let b=0;b<A.length;b+=2)s[u++]=y,s[u++]=U,s[u++]=A[b],s[u++]=A[b+1]+x,s[u++]=0,s[u++]=g;for(let b=0;b<k.length/6;b++)c[p++]=w,c[p++]=w+1,c[p++]=w+2,w+=3;for(let b=0;b<M.length/8;b++)c[p++]=w,c[p++]=w+1,c[p++]=w+2,c[p++]=w+1,c[p++]=w+2,c[p++]=w+3,w+=4;c[p++]=w+0,c[p++]=w+1,c[p++]=w+2,c[p++]=w+1,c[p++]=w+3,c[p++]=w+2,w+=4}}return{vertexData:new Float32Array(s),indexData:new Uint32Array(c)}}function se(t,e){let o=0,r=0;const{width:i,height:l,mask:h}=t,a=t.pixels[0],s=[],c=[],u=dt(ot.fromJSON(e.inputUnit),"knots"),p=e.style==="wind_speed"?pt:Number.MAX_VALUE;for(let f=0;f<l;f++)for(let d=0;d<i;d++){const m=a[f*i+d]*u;if((!h||h[f*i+d])&&m<p){for(let x=0;x<4;x++)s[o++]=(d+.5)/i,s[o++]=(f+.5)/l,s[o++]=x<2?-.5:.5,s[o++]=x%2==0?-.5:.5,s[o++]=0,s[o++]=m;const g=4*(o/24-1);c[r++]=g,c[r++]=g+1,c[r++]=g+2,c[r++]=g+1,c[r++]=g+2,c[r++]=g+3}}return{vertexData:new Float32Array(s),indexData:new Uint32Array(c)}}function _e(t,e){return e.style==="simple_scalar"?se(t,e):e.style==="wind_speed"?le(t,e):ie(t,e)}function De(t,e,n,o=[0,0],r=.5){const{width:i,height:l,mask:h}=t,[a,s]=t.pixels,[c,u]=o,p=Math.round((i-c)/n),f=Math.round((l-u)/n),d=p*f,m=new Float32Array(d),g=new Float32Array(d),x=new Uint8Array(d);for(let M=0;M<f;M++)for(let A=0;A<p;A++){let w=0;const y=M*p+A,U=Math.max(0,M*n+u),b=Math.max(0,A*n+c),I=Math.min(l,U+n),T=Math.min(i,b+n);for(let P=U;P<I;P++)for(let v=b;v<T;v++){const B=P*i+v;if(!h||h[B]){w++;const C=[a[B],s[B]],[S,$]=C;m[y]+=S,g[y]+=$}}if(w>=(I-U)*(T-b)*(1-r)){x[y]=1;const[P,v]=Ct([m[y]/w,g[y]/w]);m[y]=P,g[y]=v}else x[y]=0,m[y]=0,g[y]=0}const k=new F({width:p,height:f,pixels:[m,g],mask:x});return k.updateStatistics(),k}const J=()=>Q.getLogger("esri.views.2d.engine.flow.dataUtils"),re=10;async function Re(t,e,n,o){const r=performance.now(),i=oe(e,n),l=performance.now(),h=he(e,i,n.width,n.height),a=performance.now(),s=ue(h),c=performance.now(),u=t==="Streamlines"?fe(s,re):pe(s),p=performance.now();return et("esri-2d-profiler")&&(J().info("I.1","_createFlowFieldFromData (ms)",Math.round(l-r)),J().info("I.2","_getStreamlines (ms)",Math.round(a-l)),J().info("I.3","createAnimatedLinesData (ms)",Math.round(c-a)),J().info("I.4","create{Streamlines|Particles}Mesh (ms)",Math.round(p-c)),J().info("I.5","createFlowMesh (ms)",Math.round(p-r)),J().info("I.6","Mesh size (bytes)",u.vertexData.buffer.byteLength+u.indexData.buffer.byteLength)),await Promise.resolve(),qt(o),u}function oe(t,e){const n=ce(e.data,e.width,e.height,t.smoothing);return t.interpolate?(o,r)=>{const i=Math.floor(o),l=Math.floor(r);if(i<0||i>=e.width)return[0,0];if(l<0||l>=e.height)return[0,0];const h=o-i,a=r-l,s=i,c=l,u=i<e.width-1?i+1:i,p=l<e.height-1?l+1:l,f=n[2*(c*e.width+s)],d=n[2*(c*e.width+u)],m=n[2*(p*e.width+s)],g=n[2*(p*e.width+u)],x=n[2*(c*e.width+s)+1],k=n[2*(c*e.width+u)+1];return[(f*(1-a)+m*a)*(1-h)+(d*(1-a)+g*a)*h,(x*(1-a)+n[2*(p*e.width+s)+1]*a)*(1-h)+(k*(1-a)+n[2*(p*e.width+u)+1]*a)*h]}:(o,r)=>{const i=Math.round(o),l=Math.round(r);return i<0||i>=e.width||l<0||l>=e.height?[0,0]:[n[2*(l*e.width+i)],n[2*(l*e.width+i)+1]]}}function ae(t,e,n,o,r,i,l,h,a){const s=[];let c=n,u=o,p=0,[f,d]=e(c,u);f*=t.velocityScale,d*=t.velocityScale;const m=Math.sqrt(f*f+d*d);let g,x;s.push({x:c,y:u,t:p,speed:m});for(let k=0;k<t.verticesPerLine;k++){let[M,A]=e(c,u);M*=t.velocityScale,A*=t.velocityScale;const w=Math.sqrt(M*M+A*A);if(w<t.minSpeedThreshold)return s;const y=M/w,U=A/w;if(c+=y*t.segmentLength,u+=U*t.segmentLength,p+=t.segmentLength/w,Math.acos(y*g+U*x)>t.maxTurnAngle)return s;if(t.collisions){const b=Math.round(c*a),I=Math.round(u*a);if(b<0||b>l-1||I<0||I>h-1)return s;const T=i[I*l+b];if(T!==-1&&T!==r)return s;i[I*l+b]=r}s.push({x:c,y:u,t:p,speed:w}),g=y,x=U}return s}function he(t,e,n,o){const r=[],i=new Ut,l=1/Math.max(t.lineCollisionWidth,1),h=Math.round(n*l),a=Math.round(o*l),s=new Int32Array(h*a);for(let u=0;u<s.length;u++)s[u]=-1;const c=[];for(let u=0;u<o;u+=t.lineSpacing)for(let p=0;p<n;p+=t.lineSpacing)c.push({x:p,y:u,sort:i.getFloat()});c.sort(((u,p)=>u.sort-p.sort));for(const{x:u,y:p}of c)if(i.getFloat()<t.density){const f=ae(t,e,u,p,r.length,s,h,a,l);if(f.length<2)continue;r.push(f)}return r}function ce(t,e,n,o){if(o===0)return t;const r=Math.round(3*o),i=new Array(2*r+1);let l=0;for(let s=-r;s<=r;s++){const c=Math.exp(-s*s/(o*o));i[s+r]=c,l+=c}for(let s=-r;s<=r;s++)i[s+r]/=l;const h=new Float32Array(t.length);for(let s=0;s<n;s++)for(let c=0;c<e;c++){let u=0,p=0;for(let f=-r;f<=r;f++){if(c+f<0||c+f>=e)continue;const d=i[f+r];u+=d*t[2*(s*e+(c+f))],p+=d*t[2*(s*e+(c+f))+1]}h[2*(s*e+c)]=u,h[2*(s*e+c)+1]=p}const a=new Float32Array(t.length);for(let s=0;s<e;s++)for(let c=0;c<n;c++){let u=0,p=0;for(let f=-r;f<=r;f++){if(c+f<0||c+f>=n)continue;const d=i[f+r];u+=d*h[2*((c+f)*e+s)],p+=d*h[2*((c+f)*e+s)+1]}a[2*(c*e+s)]=u,a[2*(c*e+s)+1]=p}return a}function ue(t,e){const n=new Ut,o=t.reduce(((a,s)=>a+s.length),0),r=new Float32Array(4*o),i=new Array(t.length);let l=0,h=0;for(const a of t){const s=l;for(const c of a)r[4*l]=c.x,r[4*l+1]=c.y,r[4*l+2]=c.t,r[4*l+3]=c.speed,l++;i[h++]={startVertex:s,numberOfVertices:a.length,totalTime:a[a.length-1].t,timeSeed:n.getFloat()}}return{lineVertices:r,lineDescriptors:i}}function fe(t,e){const{lineVertices:o,lineDescriptors:r}=t;let i=0,l=0;for(const f of r)i+=2*f.numberOfVertices,l+=6*(f.numberOfVertices-1);const h=new Float32Array(i*9),a=new Uint32Array(l);let s=0,c=0;function u(){a[c++]=s-2,a[c++]=s,a[c++]=s-1,a[c++]=s,a[c++]=s+1,a[c++]=s-1}function p(f,d,m,g,x,k,M,A){const w=s*9;let y=0;h[w+y++]=f,h[w+y++]=d,h[w+y++]=1,h[w+y++]=m,h[w+y++]=k,h[w+y++]=M,h[w+y++]=g/2,h[w+y++]=x/2,h[w+y++]=A,s++,h[w+y++]=f,h[w+y++]=d,h[w+y++]=-1,h[w+y++]=m,h[w+y++]=k,h[w+y++]=M,h[w+y++]=-g/2,h[w+y++]=-x/2,h[w+y++]=A,s++}for(const f of r){const{totalTime:d,timeSeed:m}=f;let g=null,x=null,k=null,M=null,A=null,w=null;for(let y=0;y<f.numberOfVertices;y++){const U=o[4*(f.startVertex+y)],b=o[4*(f.startVertex+y)+1],I=o[4*(f.startVertex+y)+2],T=o[4*(f.startVertex+y)+3];let P=null,v=null,B=null,C=null;if(y>0){P=U-g,v=b-x;const S=Math.sqrt(P*P+v*v);if(P/=S,v/=S,y>1){let $=P+A,V=v+w;const _=Math.sqrt($*$+V*V);$/=_,V/=_;const E=Math.min(1/($*P+V*v),e);$*=E,V*=E,B=-V,C=$}else B=-v,C=P;B!==null&&C!==null&&(p(g,x,k,B,C,d,m,T),u())}g=U,x=b,k=I,A=P,w=v,M=T}p(g,x,k,-w,A,d,m,M)}return{vertexData:h,indexData:a}}function pe(t){const{lineVertices:r,lineDescriptors:i}=t;let l=0,h=0;for(const S of i){const $=S.numberOfVertices-1;l+=4*$*2,h+=6*$*2}const a=new Float32Array(l*16),s=new Uint32Array(h);let c,u,p,f,d,m,g,x,k,M,A,w,y,U,b=0,I=0;function T(){s[I++]=b-8,s[I++]=b-7,s[I++]=b-6,s[I++]=b-7,s[I++]=b-5,s[I++]=b-6,s[I++]=b-4,s[I++]=b-3,s[I++]=b-2,s[I++]=b-3,s[I++]=b-1,s[I++]=b-2}function P(S,$,V,_,E,G,L,q,W,X,tt,K,nt,it){const D=b*16;let j=0;for(const at of[1,2])for(const _t of[1,2,3,4])a[D+j++]=S,a[D+j++]=$,a[D+j++]=V,a[D+j++]=_,a[D+j++]=L,a[D+j++]=q,a[D+j++]=W,a[D+j++]=X,a[D+j++]=at,a[D+j++]=_t,a[D+j++]=nt,a[D+j++]=it,a[D+j++]=E/2,a[D+j++]=G/2,a[D+j++]=tt/2,a[D+j++]=K/2,b++}function v(S,$){let V=k+A,_=M+w;const E=Math.sqrt(V*V+_*_);V/=E,_/=E;const G=k*V+M*_;V/=G,_/=G;let L=A+y,q=w+U;const W=Math.sqrt(L*L+q*q);L/=W,q/=W;const X=A*L+w*q;L/=X,q/=X,P(c,u,p,f,-_,V,d,m,g,x,-q,L,S,$),T()}function B(S,$,V,_,E,G){if(k=A,M=w,A=y,w=U,k==null&&M==null&&(k=A,M=w),d!=null&&m!=null){y=S-d,U=$-m;const L=Math.sqrt(y*y+U*U);y/=L,U/=L}k!=null&&M!=null&&v(E,G),c=d,u=m,p=g,f=x,d=S,m=$,g=V,x=_}function C(S,$){k=A,M=w,A=y,w=U,k==null&&M==null&&(k=A,M=w),k!=null&&M!=null&&v(S,$)}for(const S of i){c=null,u=null,p=null,f=null,d=null,m=null,g=null,x=null,k=null,M=null,A=null,w=null,y=null,U=null;const{totalTime:$,timeSeed:V}=S;for(let _=0;_<S.numberOfVertices;_++)B(r[4*(S.startVertex+_)],r[4*(S.startVertex+_)+1],r[4*(S.startVertex+_)+2],r[4*(S.startVertex+_)+3],$,V);C($,V)}return{vertexData:a,indexData:s}}function bt(t,e){const n=e.pixels,{width:o,height:r}=e,i=new Float32Array(o*r*2),l=e.mask||new Uint8Array(o*r*2);if(e.mask||l.fill(255),t==="vector-uv")for(let h=0;h<o*r;h++)i[2*h]=n[0][h],i[2*h+1]=-n[1][h];else if(t==="vector-magdir")for(let h=0;h<o*r;h++){const a=n[0][h],s=Wt(n[1][h]),c=Math.cos(s-Math.PI/2),u=Math.sin(s-Math.PI/2);i[2*h]=c*a,i[2*h+1]=u*a}return{data:i,mask:l,width:o,height:r}}async function Le(t,e,n,o,r,i){const l=performance.now(),h=Gt(e.spatialReference);if(!h){const A=await vt(t,e,n,o,r,i);return et("esri-2d-profiler")&&J().info("I.7","loadImagery, early exit (ms)",Math.round(performance.now()-l)),et("esri-2d-profiler")&&J().info("I.9","Number of parts",1),A}const[a,s]=h.valid,c=s-a,u=Math.ceil(e.width/c),p=e.width/u,f=Math.round(n/u);let d=e.xmin;const m=[],g=performance.now();for(let A=0;A<u;A++){const w=new Ot({xmin:d,xmax:d+p,ymin:e.ymin,ymax:e.ymax,spatialReference:e.spatialReference});m.push(vt(t,w,f,o,r,i)),d+=p}const x=await Promise.all(m);et("esri-2d-profiler")&&J().info("I.8","All calls to _fetchPart (ms)",Math.round(performance.now()-g)),et("esri-2d-profiler")&&J().info("I.9","Number of parts",x.length);const k={data:new Float32Array(n*o*2),mask:new Uint8Array(n*o),width:n,height:o};let M=0;for(const A of x){for(let w=0;w<A.height;w++)for(let y=0;y<A.width;y++)M+y>=n||(k.data[2*(w*n+M+y)]=A.data[2*(w*A.width+y)],k.data[2*(w*n+M+y)+1]=A.data[2*(w*A.width+y)+1],k.mask[w*n+M+y]=A.mask[w*A.width+y]);M+=A.width}return et("esri-2d-profiler")&&J().info("I.10","loadImagery, general exit (ms)",Math.round(performance.now()-l)),k}async function vt(t,e,n,o,r,i){var a;const l={requestProjectedLocalDirections:!0,signal:i};if(r!=null&&(l.timeExtent=r),t.type==="imagery"){await t.load({signal:i});const s=await t.internalFetchImage(e,n,o,l);return((a=s==null?void 0:s.pixelData)==null?void 0:a.pixelBlock)==null?{data:new Float32Array(n*o*2),mask:new Uint8Array(n*o),width:n,height:o}:bt(t.rasterInfo.dataType,s.pixelData.pixelBlock)}await t.load({signal:i});const h=await t.fetchPixels(e,n,o,l);return(h==null?void 0:h.pixelBlock)==null?{data:new Float32Array(n*o*2),mask:new Uint8Array(n*o),width:n,height:o}:bt(t.serviceRasterInfo.dataType,h.pixelBlock)}export{Me as A,Te as B,Se as D,Ie as I,Ue as M,$e as R,De as S,Xt as T,Pe as U,$t as W,se as _,_e as a,ot as b,F as c,dt as d,Pt as e,At as f,Le as g,we as h,ke as i,Be as j,ye as k,Ct as l,Ve as m,xe as n,ge as o,Ce as p,xt as q,R as r,Re as s,gt as t,Fe as u,wt as v,be as w,ve as x,Tt as y,Ae as z};
