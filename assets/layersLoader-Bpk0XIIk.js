import{cM as g,cN as M,ay as y,aB as F,cO as I,av as P,cP as $,cQ as G,aJ as k}from"./index-C2z3vZ9k.js";import{t as b,n as x}from"./fetchService-DEjjtKAE.js";import{o as D,u as C,s as m,l as A,y as E,c as v,e as L,i as O,a as w}from"./loadUtils-B_ov70Np.js";import"./associatedFeatureServiceUtils-C1sHcIUO.js";async function te(t,o){const r=t.instance.portalItem;if(r!=null&&r.id)return await r.load(o),j(t),t.validateItem&&t.validateItem(r),J(t,o)}function j(t){const o=t.instance.portalItem;if(!(o!=null&&o.type)||!t.supportedTypes.includes(o.type))throw new y("portal:invalid-layer-item-type","Invalid layer item type '${type}', expected '${expectedType}'",{type:o==null?void 0:o.type,expectedType:t.supportedTypes.join(", ")})}async function J(t,o){const r=t.instance,e=r.portalItem;if(!e)return;let{url:l}=e;const{title:a}=e,s=g(e,"portal-item");if(r.type==="group")return N(r,s,t);l&&r.type!=="media"&&r.read({url:l},s);const u=new L,{data:c,preferredHost:n}=await S(t,u,o);return l=e.url,"isUrlHostModified"in r&&(n?r.applyPreferredHost({preferredHost:n}):r.applyHostFromPortalItem()),c&&r.read(c,s),r.resourceReferences={portalItem:e,paths:s.readResourcePaths??[]},r.type!=="subtype-group"&&r.read({title:a},s),M(r,s)}async function N(t,o,r){const e=t.portalItem;if(!t.sourceIsPortalItem)return;const{title:l,type:a}=e;if(a==="Group Layer"){if(!F(e,"Map"))throw new y("portal:invalid-layer-item-typekeyword","'Group Layer' item without 'Map' type keyword is not supported");return R(t,r)}return t.read({title:l},o),V(t,r)}async function R(t,o){const r=t.portalItem,e=await r.fetchData("json");if(!e)return;if(!o.populateGroupLayer)throw new y("portal:missing-populate-group-layer","Missing populate group layer");const l=g(r,"web-map");t.read(e,l),await o.populateGroupLayer(t,e,{context:l}),t.resourceReferences={portalItem:r,paths:l.readResourcePaths??[]}}async function V(t,o){var p;let r;const{portalItem:e}=t;if(!e)return;const l=e.type,a=o.layerModuleTypeMap;if(!a)throw new y("portal:missing-layer-module-type-map","Layer module type map is required to construct sub layers");switch(l){case"Feature Service":case"Feature Collection":r=a.FeatureLayer;break;case"Stream Service":r=a.StreamLayer;break;case"Scene Service":r=a.SceneLayer;break;case"Video Service":r=a.VideoLayer;break;default:throw new y("portal:unsupported-item-type-as-group",`The item type '${l}' is not supported as a 'IGroupLayer'`)}const s=l==="Video Service",u=new L;let[c,{data:n}]=await Promise.all([r(),s?{data:null}:S(o,u)]),i=()=>c;if(s)return q(t,i,a);if(l==="Feature Service"){const f=(p=m(n))==null?void 0:p.customParameters;n=e.url?(await A(n,e.url,u)).data:{},i=await X(n,a)||i;const{provider:T,preferredHost:H}=await W(e.url,{customParameters:f,loadContext:u});return I(e,H),await d(t,i,i,n,a,T)}return l==="Scene Service"&&e.url&&(n=await E(e,n,u)),v(n)>0?await d(t,i,null,n,a):await U(t,i,a)}async function U(t,o,r){var a,s;const{portalItem:e}=t;if(!(e!=null&&e.url))return;const l=await b(e.url);l&&d(t,o,null,{layers:(a=l.layers)==null?void 0:a.map(w),tables:(s=l.tables)==null?void 0:s.map(w)},r)}async function q(t,o,r){var a;const{portalItem:e}=t;if(!(e!=null&&e.url))return;const l=await b(e.url);l&&d(t,o,null,{layers:(a=l.layers)==null?void 0:a.map((({id:s,name:u})=>({id:s,name:u})))},r)}async function d(t,o,r,e,l,a){var c;let s=e.layers||[];const u=e.tables||[];if(((c=t.portalItem)==null?void 0:c.type)==="Feature Collection"?(s.forEach(((n,i)=>{var p;n.id=i,((p=n==null?void 0:n.layerDefinition)==null?void 0:p.type)==="Table"&&u.push(n)})),s=s.filter((n=>{var i;return((i=n==null?void 0:n.layerDefinition)==null?void 0:i.type)!=="Table"}))):(s.reverse(),u.reverse()),s.forEach((n=>{const i=a==null?void 0:a(n);if(i||!a){const p=h(t,o(n),e,n,i);t.add(p)}})),u.length){const n=r?null:await l.FeatureLayer();u.forEach((i=>{const p=a==null?void 0:a(i);if(p||!a){const f=h(t,r?r(i):n,e,i,p);t.tables.add(f)}}))}}function h(t,o,r,e,l){const a=t.portalItem,s={portalItem:a.clone(),layerId:e.id};e.url!=null&&(s.url=e.url);const u=new o(s);if("sourceJSON"in u&&(u.sourceJSON=l),u.type!=="subtype-group"&&u.type!=="catalog"&&(u.sublayerTitleMode="service-name"),a.type==="Feature Collection"){const c={origin:"portal-item",portal:a.portal||k.getDefault()};u.read(e,c);const n=r.showLegend;n!=null&&u.read({showLegend:n},c)}return u}async function S(t,o,r){if(t.supportsData===!1)return{data:void 0};const e=t.instance,l=e.portalItem;if(!l)return{data:void 0};let a=null;try{a=await l.fetchData("json",r)}catch{}if(z(e)){let s=null;const{count:u,preferredHost:c}=await B(l,a,o);if(I(l,c),((a==null?void 0:a.layers)||(a==null?void 0:a.tables))&&u>0){if(e.layerId==null){const n=D(e.type),i=n!=null&&n.length?C(a,n)[0]:m(a);i&&(e.layerId=i.id)}s=Q(a,e),(s==null?void 0:s.layerType)==="OrientedImageryLayer"&&e.type==="oriented-imagery"&&e.supportedSourceTypes.add("Feature Layer"),s&&a.showLegend!=null&&(s.showLegend=a.showLegend)}return u>1&&"sublayerTitleMode"in e&&e.sublayerTitleMode!=="service-name"&&(e.sublayerTitleMode="item-title-and-service-name"),{data:s,preferredHost:c}}return{data:a}}async function B(t,o,r){var s,u,c,n,i;if(o!=null&&o.layers&&(o!=null&&o.tables))return{count:v(o)};const e=P(t.url);if(!e)return{count:1};const l=e.url.path,a=await r.fetchServiceMetadata(l,{customParameters:(s=m(o))==null?void 0:s.customParameters}).catch((()=>null));return{count:(((u=o==null?void 0:o.layers)==null?void 0:u.length)??((c=a==null?void 0:a.layers)==null?void 0:c.length)??0)+(((n=o==null?void 0:o.tables)==null?void 0:n.length)??((i=a==null?void 0:a.tables)==null?void 0:i.length)??0),preferredHost:G(t)?$():null}}function Q(t,o){var l,a;const{layerId:r}=o,e=((l=t.layers)==null?void 0:l.find((s=>s.id===r)))||((a=t.tables)==null?void 0:a.find((s=>s.id===r)));return e&&K(e,o)?e:null}function z(t){return t.type!=="stream"&&"layerId"in t}function K(t,o){const r="layerType"in t&&t.layerType,{type:e}=o;return!(e==="feature"&&r&&t.layerType!=="ArcGISFeatureLayer"||e==="catalog"&&!r||e==="oriented-imagery"&&!r||e==="subtype-group"&&!r)}async function W(t,o){const{layersJSON:r,preferredHost:e}=await x(t,o);if(!r)return{provider:null,preferredHost:e};const l=[...r.layers,...r.tables];return{provider:a=>l.find((s=>s.id===a.id)),preferredHost:e}}async function X(t,o){const{layers:r,tables:e}=t,l=[...r??[],...e??[]];if(!l.length)return;const a=new Set,s=[];for(const{layerType:n}of l){const i=n??"ArcGISFeatureLayer";if(a.has(i))continue;a.add(i);const p=o[O(i)];s.push(p())}const u=await Promise.all(s),c=new Map;return Array.from(a).forEach(((n,i)=>{c.set(n,u[i])})),({layerType:n})=>{const i=n??"ArcGISFeatureLayer";return c.get(i)}}export{te as load};
